<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${sub != null ? sub.title : 'Reader'}">Reader</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/tailwind-config.js"></script>
    <script src="/js/ai-translate-btn.js"></script>
    <script src="/js/thinking-border.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      id="hljsThemeLight"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    />
    <link
      id="hljsThemeDark"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
      disabled
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
    />
    <link rel="stylesheet" href="/css/ai-translate-btn.css" />
    <link rel="stylesheet" href="/css/thinking-border.css" />
    <style>
      .show {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
      }

      .show {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
      }

      /* Markdown typography */

      #mdContainer h1 {
        color: #0f172a;
        font-size: 2rem;
        line-height: 2.5rem;
        font-weight: 700;
        margin: 1.25rem 0 0.75rem;
      }

      #mdContainer h2 {
        color: #0f172a;
        font-size: 1.5rem;
        line-height: 2rem;
        font-weight: 700;
        margin: 1.2rem 0 0.7rem;
      }

      #mdContainer h3 {
        color: #0f172a;
        font-size: 1.25rem;
        line-height: 1.75rem;
        font-weight: 700;
        margin: 1.1rem 0 0.6rem;
      }

      #mdContainer h4 {
        color: #0f172a;
        font-size: 1.125rem;
        line-height: 1.6rem;
        font-weight: 700;
        margin: 1rem 0 0.5rem;
      }

      #mdContainer h5 {
        color: #0f172a;
        font-size: 1rem;
        line-height: 1.5rem;
        font-weight: 700;
        margin: 0.9rem 0 0.45rem;
      }

      #mdContainer h6 {
        color: #0f172a;
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin: 0.8rem 0 0.4rem;
      }

      #mdContainer p {
        margin: 0.75rem 0;
        color: #334155;
      }

      #mdContainer a {
        color: #2563eb;
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      #mdContainer ul,
      #mdContainer ol {
        margin: 0.75rem 0 0.75rem 1.25rem;
        padding-left: 1.25rem;
      }
      /* Unordered lists */

      #mdContainer ul {
        list-style-type: disc;
        list-style-position: outside;
      }

      #mdContainer ul ul {
        list-style-type: circle;
      }

      #mdContainer ul ul ul {
        list-style-type: square;
      }
      /* Ordered lists */

      #mdContainer ol {
        list-style-type: decimal;
        list-style-position: outside;
      }

      #mdContainer ol ol {
        list-style-type: lower-alpha;
      }

      #mdContainer ol ol ol {
        list-style-type: lower-roman;
      }

      #mdContainer li {
        margin: 0.25rem 0;
      }

      #mdContainer li p {
        margin: 0.25rem 0;
      }
      /* Task list checkboxes (GFM) */

      #mdContainer li > input[type="checkbox"] {
        margin-right: 0.5rem;
        vertical-align: middle;
      }

      #mdContainer blockquote {
        border-left: 4px solid #e2e8f0;
        padding: 0.5rem 1rem;
        margin: 1rem 0;
        color: #334155;
        background: #f8fafc;
        border-radius: 0.5rem;
      }

      #mdContainer pre {
        background: #f6f8fa;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        overflow: auto;
      }

      #mdContainer code {
        background: #f1f5f9;
        color: #0f172a;
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
      }

      #mdContainer table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
      }

      #mdContainer th,
      #mdContainer td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem 0.6rem;
      }

      #mdContainer th {
        background: #f8fafc;
        text-align: left;
        color: #0f172a;
      }

      #mdContainer hr {
        border: none;
        height: 1px;
        background: #e5e7eb;
        margin: 1.25rem 0;
      }
      /* Media sizing: keep images/diagrams from becoming too large */

      #mdContainer img,
      #mdContainer svg,
      #mdContainer video,
      #mdContainer iframe {
        display: block;
        max-width: min(100%, 720px);
        height: auto;
        margin: 0.5rem auto;
      }
      /* Cap image height to avoid overly tall images */

      #mdContainer img {
        max-height: 60vh;
      }
      /* Mermaid diagrams (SVG) */

      #mdContainer .mermaid {
        max-width: min(100%, 720px);
        margin: 0.5rem auto;
        overflow: hidden;
      }
      /* Figure captions */

      #mdContainer figure {
        margin: 0.75rem auto;
        text-align: center;
      }

      #mdContainer figcaption {
        color: #64748b;
        font-size: 0.875rem;
      }
      /* Horizontal scroll helpers */

      .scrollbar-none {
        scrollbar-width: none;
      }

      .scrollbar-none::-webkit-scrollbar {
        display: none;
      }
      /* Drawer accordion */

      .drawer-acc {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition:
          max-height 0.3s ease,
          opacity 0.2s ease;
      }

      .drawer-acc.open {
        max-height: 1000px;
        opacity: 1;
      }

      .acc-icon {
        transition: transform 0.2s ease;
      }

      #mdPanel.md-dark {
        background: #0b1220 !important;
        border-color: #334155 !important;
      }

      #mdPanel.md-dark #mdContainer {
        background: rgba(2, 6, 23, 0.35);
        border-color: #334155;
        color: #e2e8f0;
      }

      #mdPanel.md-dark #mdContainer h1,
      #mdPanel.md-dark #mdContainer h2,
      #mdPanel.md-dark #mdContainer h3,
      #mdPanel.md-dark #mdContainer h4,
      #mdPanel.md-dark #mdContainer h5,
      #mdPanel.md-dark #mdContainer h6 {
        color: #f1f5f9;
      }

      #mdPanel.md-dark #mdContainer p,
      #mdPanel.md-dark #mdContainer li {
        color: #cbd5e1;
      }

      #mdPanel.md-dark #mdContainer a {
        color: #93c5fd;
      }

      #mdPanel.md-dark #mdContainer blockquote {
        border-left-color: #334155;
        background: rgba(15, 23, 42, 0.6);
        color: #cbd5e1;
      }

      #mdPanel.md-dark #mdContainer pre {
        background: rgba(2, 6, 23, 0.7);
        border-color: #334155;
      }

      #mdPanel.md-dark #mdContainer code {
        background: rgba(148, 163, 184, 0.12);
        color: #e2e8f0;
      }

      #mdPanel.md-dark #mdContainer th,
      #mdPanel.md-dark #mdContainer td {
        border-color: #334155;
      }

      #mdPanel.md-dark #mdContainer th {
        background: rgba(15, 23, 42, 0.55);
        color: #e2e8f0;
      }

      #mdPanel.md-dark #mdContainer hr {
        background: #334155;
      }

      #mdPanel.md-dark #mdContainer figcaption {
        color: #94a3b8;
      }

      #mdContainer {
        font-size: var(--md-font-size, 16px);
      }

      #mdPanel.md-dark #mdToolbar {
        border-color: rgba(148, 163, 184, 0.22);
      }

      #mdPanel.md-dark #mdToolbar .md-toolbar-btn {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(148, 163, 184, 0.18);
        color: rgba(226, 232, 240, 0.9);
      }

      #mdPanel.md-dark #mdToolbar .md-toolbar-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(241, 245, 249, 1);
      }

      #mdPanel.md-dark #mdToolbar .md-toolbar-select {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(148, 163, 184, 0.18);
        color: rgba(226, 232, 240, 0.9);
      }

      #mdPanel.md-dark #mdToolbar .md-toolbar-label {
        color: rgba(226, 232, 240, 0.7);
      }

      #mdToolbar .md-toolbar-btn.md-active {
        background: rgba(15, 23, 42, 0.08);
        color: rgba(15, 23, 42, 0.9);
      }

      #mdPanel.md-dark #mdToolbar .md-toolbar-btn.md-active {
        background: rgba(255, 255, 255, 0.14);
        color: rgba(241, 245, 249, 1);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-sub@1.0.0/dist/markdown-it-sub.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-sup@1.0.0/dist/markdown-it-sup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath@1.0.0/texmath.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  </head>

  <body class="min-h-screen font-sans text-gray-800 flex flex-col">
    <!-- Navbar (shared fragment) -->
    <nav th:replace="fragments/navbar :: appNavbar('Reader')"></nav>

    <!-- Main Content -->
    <main class="flex-1 pt-24 pb-16">
      <div id="contentWrap" class="transition-all">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <div class="flex items-center gap-3 sm:gap-3 min-w-0">
              <button
                id="openDrawerBtn"
                type="button"
                class="flex items-center gap-2 text-white/80 hover:text-white transition bg-white/10 hover:bg-white/15 px-3 py-2 rounded-lg no-underline flex-shrink-0 mt-1 sm:mt-0"
              >
                <i class="fas fa-bars text-xs"></i>
                <span class="hidden sm:inline" th:text="#{reader.drawer.show}"
                  >Show</span
                >
              </button>
            </div>
            <a
              th:href="@{/contents(courseId=${course.id})}"
              class="flex items-center gap-2 text-white/80 hover:text-white transition bg-white/10 hover:bg-white/15 px-3 py-2 rounded-lg no-underline flex-shrink-0 mt-1 sm:mt-0"
            >
              <i class="fas fa-arrow-left text-xs"></i>
              <span th:text="#{reader.back}">Back</span>
            </a>
          </div>

          <div class="mb-4">
            <nav
              class="flex items-center text-sm sm:text-base text-white/85"
              aria-label="Breadcrumb"
            >
              <ol class="flex flex-wrap items-center gap-x-1.5 gap-y-1">
                <li
                  th:if="${course != null}"
                  class="flex items-center gap-1 min-w-0"
                >
                  <span class="truncate max-w-[8rem] sm:max-w-[14rem]">
                    <span
                      class="px-2 py-0.5 rounded-full bg-white/15 text-white font-semibold"
                      th:text="${course.title}"
                    >
                      Course Title
                    </span>
                  </span>
                </li>
                <li
                  th:if="${course != null && content != null}"
                  class="text-white/40"
                >
                  <i class="fas fa-chevron-right text-[9px]"></i>
                </li>
                <li
                  th:if="${content != null}"
                  class="flex items-center gap-1 min-w-0"
                >
                  <span
                    class="truncate max-w-[8rem] sm:max-w-[11rem] font-medium"
                    th:text="${content.chapter != null ? content.chapter : 'Chapter ' + content.order}"
                    >Chapter 1</span
                  >
                </li>
                <li
                  th:if="${content != null && sub != null}"
                  class="text-white/40"
                >
                  <i class="fas fa-chevron-right text-[9px]"></i>
                </li>
                <li
                  th:if="${sub != null}"
                  class="flex items-center gap-1 min-w-0"
                >
                  <span
                    class="truncate max-w-[11rem] sm:max-w-[16rem] font-medium"
                    th:text="${sub.title}"
                    >Subchapter Title</span
                  >
                </li>
              </ol>
            </nav>
          </div>

          <div
            id="mdPanel"
            class="bg-amber-50/70 border border-slate-200 rounded-xl p-3 sm:p-4 mb-3 transition-colors duration-200"
          >
            <div
              id="mdToolbar"
              class="flex flex-wrap items-center justify-end gap-3 pb-3 mb-4 border-b border-slate-200/70"
            >
              <div
                class="inline-flex"
                role="group"
                th:attr="aria-label=#{reader.fontSize.ariaLabel}"
              >
                <button
                  type="button"
                  class="md-toolbar-btn md-font-btn inline-flex items-center justify-center h-9 w-9 text-sm font-semibold rounded-l-lg border border-slate-200 bg-white/70 hover:bg-white text-slate-700 transition"
                  data-md-font-size="14"
                  aria-pressed="false"
                >
                  S
                </button>
                <button
                  type="button"
                  class="md-toolbar-btn md-font-btn -ml-px inline-flex items-center justify-center h-9 w-9 text-sm font-semibold border border-slate-200 bg-white/70 hover:bg-white text-slate-700 transition"
                  data-md-font-size="16"
                  aria-pressed="false"
                >
                  M
                </button>
                <button
                  type="button"
                  class="md-toolbar-btn md-font-btn -ml-px inline-flex items-center justify-center h-9 w-9 text-sm font-semibold rounded-r-lg border border-slate-200 bg-white/70 hover:bg-white text-slate-700 transition"
                  data-md-font-size="18"
                  aria-pressed="false"
                >
                  L
                </button>
              </div>

              <button
                id="mdTranslateBtn"
                type="button"
                class="ai-translate-btn"
                aria-pressed="false"
              >
                <svg
                  id="mdTranslateBtnIcon"
                  class="ai-translate-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <path
                    d="M12 2l1.1 4.2L17 7.3l-3.9 1.1L12 12l-1.1-3.6L7 7.3l3.9-1.1L12 2zM19 10l.8 2.8L22 14l-2.2.6L19 17l-.8-2.4L16 14l2.2-1.2L19 10zM6 13l1 3.4L10 17l-3 .9L6 21l-1-3.1L2 17l3-0.6L6 13z"
                    fill="currentColor"
                  />
                </svg>
                <span
                  id="mdTranslateBtnLabel"
                  class="ai-translate-text"
                  th:text="#{reader.translate}"
                  >Translate</span
                >
              </button>

              <button
                id="mdThemeToggle"
                type="button"
                class="md-toolbar-btn inline-flex items-center justify-center h-9 w-9 rounded-lg border border-slate-200 bg-white/70 hover:bg-white text-slate-700 transition"
                aria-pressed="false"
              >
                <i id="mdThemeToggleIcon" class="fas fa-moon text-xs"></i>
                <span
                  id="mdThemeToggleLabel"
                  class="sr-only"
                  th:text="#{reader.theme.darkMode}"
                  >Dark</span
                >
              </button>
            </div>
            <article
              id="mdContainer"
              class="prose max-w-none text-slate-800 bg-white/80 border border-slate-200/70 rounded-lg p-4 sm:p-6"
            ></article>
          </div>

          <!-- Subchapter navigation (only Prev/Next) -->
          <div th:if="${content != null && sub != null}" class="mt-2">
            <div class="flex items-center justify-end gap-1">
              <nav
                class="flex items-center gap-1"
                th:attr="aria-label=#{reader.pagination.ariaLabel}"
              >
                <!-- Prev (always visible) -->
                <a
                  id="readerPrevPage"
                  class="inline-flex items-center justify-center h-9 w-9 rounded-md border bg-white/80 text-slate-700 no-underline transition focus:outline-none focus:ring-2 focus:ring-primary-500/30"
                  th:classappend="${hasPrev} ? ' border-slate-200 hover:bg-white' : ' border-slate-100 text-slate-300 bg-white/60 cursor-not-allowed pointer-events-none opacity-60'"
                  th:attr="href=${hasPrev} ? @{/reader(courseId=${course.id}, ch=${prevCh}, sc=${prevSc})} : null, aria-disabled=${!hasPrev}, title=#{reader.pagination.previous}"
                >
                  <i class="fas fa-chevron-left text-xs"></i>
                </a>
                <!-- Next (always visible) -->
                <a
                  id="readerNextPage"
                  class="inline-flex items-center justify-center h-9 w-9 rounded-md border bg-white/80 text-slate-700 no-underline transition focus:outline-none focus:ring-2 focus:ring-primary-500/30"
                  th:classappend="${hasNext} ? ' border-slate-200 hover:bg-white' : ' border-slate-100 text-slate-300 bg-white/60 cursor-not-allowed pointer-events-none opacity-60'"
                  th:attr="href=${hasNext} ? @{/reader(courseId=${course.id}, ch=${nextCh}, sc=${nextSc})} : null, aria-disabled=${!hasNext}, title=#{reader.pagination.next}"
                >
                  <i class="fas fa-chevron-right text-xs"></i>
                </a>
              </nav>
            </div>
          </div>

          <!-- Left Drawer: Subchapters (persistent) -->
          <aside
            id="subDrawer"
            class="fixed left-0 top-[72px] bottom-0 w-80 max-w-[85%] -translate-x-full bg-white/60 backdrop-blur-lg supports-[backdrop-filter]:bg-white/50 shadow-2xl border-r border-slate-200 transition-transform duration-200 z-40"
          >
            <div class="h-full flex flex-col">
              <!-- Current selection summary -->
              <div
                class="px-3 pt-3 pb-3 border-b border-slate-200/60 bg-white/70"
              >
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div
                      class="text-[11px] uppercase tracking-wide text-slate-500"
                      th:text="${content != null ? (content.chapter != null ? content.chapter : 'Chapter ' + content.order) : ''}"
                    >
                      Chapter
                    </div>
                    <div
                      class="text-sm sm:text-base font-semibold text-slate-900 truncate"
                      th:text="${content != null ? content.title : ''}"
                    >
                      Chapter Title
                    </div>
                    <div
                      class="text-xs sm:text-[13px] text-slate-600 truncate"
                      th:text="${sub != null ? sub.title : ''}"
                    >
                      Subchapter Title
                    </div>
                  </div>
                  <button
                    id="closeDrawerBtn"
                    type="button"
                    class="inline-flex items-center justify-center h-9 w-9 rounded-lg bg-white/80 hover:bg-white border border-slate-200 text-slate-700 transition flex-none"
                    th:attr="aria-label=#{reader.drawer.closeAria}, title=#{reader.drawer.close}"
                  >
                    <i class="fas fa-xmark"></i>
                  </button>
                </div>
              </div>
              <!-- Scrollable chapters/subchapters accordion -->
              <div class="px-3 pt-2 pb-3 flex-1 overflow-y-auto">
                <div th:each="c : ${course.contents}" class="mb-2">
                  <!-- Chapter (Disclosure button) -->
                  <button
                    type="button"
                    class="chapter-toggle w-full flex items-center justify-between rounded-md px-3 py-2 text-left text-sm font-medium text-slate-800 hover:bg-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600"
                    th:data-ch="${c.order}"
                    th:classappend="${c.order == content.order} ? ' bg-primary-100 text-primary-900 ring-1 ring-primary-300' : ''"
                    aria-expanded="false"
                  >
                    <span class="flex items-center gap-2 min-w-0">
                      <span
                        class="inline-flex items-center justify-center h-6 w-6 rounded-md bg-slate-100 text-slate-600 text-xs font-medium"
                        th:text="${c.order}"
                        >1</span
                      >
                      <span class="truncate" th:text="${c.title}"
                        >Chapter Title</span
                      >
                    </span>
                    <i
                      class="fas fa-chevron-down acc-icon text-[11px] text-gray-400"
                    ></i>
                  </button>
                  <!-- Subchapters (panel) -->
                  <div
                    class="drawer-acc"
                    th:classappend="${c.order == content.order} ? ' open' : ''"
                  >
                    <nav
                      class="mt-0.5 divide-y divide-slate-200/30 pl-2 sm:pl-3"
                      th:attr="aria-label=#{reader.subchapters.ariaLabel}"
                    >
                      <a
                        th:each="s : ${c.subcontents}"
                        th:href="@{/reader(courseId=${course.id}, ch=${c.order}, sc=${s.order})}"
                        class="flex items-center gap-2 no-underline px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50/60 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600 min-w-0"
                        th:classappend="${c.order == content.order && s.order == sub.order} ? ' bg-secondary-50/60 text-secondary-600 ring-1 ring-inset ring-secondary-200/70' : ''"
                      >
                        <span
                          class="inline-flex items-center justify-center h-5 px-1.5 rounded bg-slate-50/80 text-slate-600 text-[11px] font-medium flex-none whitespace-nowrap"
                          th:text="${c.order + '-' + s.order}"
                          >1-1</span
                        >
                        <span class="truncate flex-1" th:text="${s.title}"
                          >Subchapter</span
                        >
                      </a>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </aside>
          <div
            id="drawerBackdrop"
            class="fixed inset-x-0 top-[72px] bottom-0 bg-slate-900/30 opacity-0 pointer-events-none transition-opacity duration-200 z-30"
          ></div>
          <div id="mdError" class="text-red-200 mt-4 hidden"></div>
        </div>
      </div>
    </main>

    <script th:inline="javascript">
      (function () {
        const mdPath = /*[[${markdownPath}]]*/ null;
        const courseId = /*[[${course != null ? course.id : null}]]*/ null;
        const ch = /*[[${content != null ? content.order : null}]]*/ null;
        const sc = /*[[${sub != null ? sub.order : null}]]*/ null;
        const courseLanguage =
          /*[[${course != null ? course.language : null}]]*/ null;
        const userLanguage = /*[[${#locale.language}]]*/ "en";

        const i18n = {
          lightMode: /*[[#{reader.theme.lightMode}]]*/ "Light mode",
          darkMode: /*[[#{reader.theme.darkMode}]]*/ "Dark mode",
          enableDarkMode:
            /*[[#{reader.theme.enableDarkMode}]]*/ "Enable dark mode",
          disableDarkMode:
            /*[[#{reader.theme.disableDarkMode}]]*/ "Disable dark mode",
          drawerShow: /*[[#{reader.drawer.show}]]*/ "Show",
          drawerHide: /*[[#{reader.drawer.hide}]]*/ "Hide",
          translate: /*[[#{reader.translate}]]*/ "Translate",
          translateMissingApiKey:
            /*[[#{reader.translate.missingApiKey}]]*/ "Translation API key is not configured.",
          translateFailedPrefix:
            /*[[#{reader.translate.failedPrefix}]]*/ "Translation failed: ",
          errorNoMarkdownPath:
            /*[[#{reader.error.noMarkdownPath}]]*/ "No markdown path provided.",
          errorLoadFailedPrefix:
            /*[[#{reader.error.loadFailedPrefix}]]*/ "Failed to load markdown: ",
        };

        const container = document.getElementById("mdContainer");
        const err = document.getElementById("mdError");
        const mdPanel = document.getElementById("mdPanel");
        const mdThemeToggle = document.getElementById("mdThemeToggle");
        const mdThemeToggleIcon = document.getElementById("mdThemeToggleIcon");
        const mdThemeToggleLabel =
          document.getElementById("mdThemeToggleLabel");
        const mdTranslateBtn = document.getElementById("mdTranslateBtn");
        const mdTranslateBtnLabel = document.getElementById(
          "mdTranslateBtnLabel",
        );
        const mdTranslateBtnIcon =
          document.getElementById("mdTranslateBtnIcon");
        const mdFontSizeButtons = Array.from(
          document.querySelectorAll("[data-md-font-size]"),
        );
        const hljsThemeLight = document.getElementById("hljsThemeLight");
        const hljsThemeDark = document.getElementById("hljsThemeDark");
        let rawMarkdownText = null;
        let translatedMarkdownText = null;
        let showingTranslated = false;
        let translateLoading = false;

        const syncTranslateBtnState = () => {
          if (!mdTranslateBtn) return;
          if (window.aiTranslateBtn?.setState) {
            window.aiTranslateBtn.setState(mdTranslateBtn, {
              active: showingTranslated,
              loading: translateLoading,
              pressed: showingTranslated,
            });
          } else {
            mdTranslateBtn.classList.toggle("is-active", !!showingTranslated);
            mdTranslateBtn.classList.toggle("is-loading", !!translateLoading);
            mdTranslateBtn.setAttribute(
              "aria-pressed",
              showingTranslated ? "true" : "false",
            );
          }
          if (mdPanel && window.thinkingBorder?.setLoading) {
            window.thinkingBorder.setLoading(mdPanel, translateLoading);
          } else if (mdPanel) {
            mdPanel.classList.toggle("thinking-border", !!translateLoading);
          }
        };

        const MD_THEME_KEY = "readerMarkdownDark";
        const setMarkdownDark = (enabled) => {
          if (mdPanel) mdPanel.classList.toggle("md-dark", !!enabled);
          const actionLabel = enabled ? i18n.lightMode : i18n.darkMode;
          const ariaLabel = enabled
            ? i18n.disableDarkMode
            : i18n.enableDarkMode;
          if (mdThemeToggle) {
            mdThemeToggle.setAttribute(
              "aria-pressed",
              enabled ? "true" : "false",
            );
            mdThemeToggle.setAttribute("aria-label", ariaLabel);
            mdThemeToggle.setAttribute("title", ariaLabel);
          }
          if (mdThemeToggleIcon) {
            mdThemeToggleIcon.classList.remove("fa-moon", "fa-sun");
            mdThemeToggleIcon.classList.add(enabled ? "fa-sun" : "fa-moon");
          }
          if (mdThemeToggleLabel) mdThemeToggleLabel.textContent = actionLabel;
          if (hljsThemeLight) hljsThemeLight.disabled = !!enabled;
          if (hljsThemeDark) hljsThemeDark.disabled = !enabled;
          try {
            localStorage.setItem(MD_THEME_KEY, enabled ? "1" : "0");
          } catch (_) {}
        };
        const getMarkdownDark = () => {
          try {
            return localStorage.getItem(MD_THEME_KEY) === "1";
          } catch (_) {
            return false;
          }
        };
        setMarkdownDark(getMarkdownDark());
        if (mdThemeToggle) {
          mdThemeToggle.addEventListener("click", () => {
            setMarkdownDark(!getMarkdownDark());
          });
        }

        const MD_FONT_SIZE_KEY = "readerMarkdownFontSize";
        const setMarkdownFontSize = (px) => {
          const n = Number(px);
          const clamped = Number.isFinite(n)
            ? Math.min(22, Math.max(12, n))
            : 16;
          if (mdPanel)
            mdPanel.style.setProperty("--md-font-size", `${clamped}px`);
          mdFontSizeButtons.forEach((btn) => {
            const btnPx = Number(btn.getAttribute("data-md-font-size"));
            const active = Number.isFinite(btnPx) && btnPx === clamped;
            btn.setAttribute("aria-pressed", active ? "true" : "false");
            btn.classList.toggle("md-active", active);
          });
          try {
            localStorage.setItem(MD_FONT_SIZE_KEY, String(clamped));
          } catch (_) {}
        };
        const getMarkdownFontSize = () => {
          try {
            const v = localStorage.getItem(MD_FONT_SIZE_KEY);
            const n = Number(v);
            return Number.isFinite(n) ? n : 16;
          } catch (_) {
            return 16;
          }
        };
        setMarkdownFontSize(getMarkdownFontSize());
        mdFontSizeButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const val = btn.getAttribute("data-md-font-size") || "16";
            setMarkdownFontSize(val);
          });
        });

        const normalizeLang = (value) => {
          const v = (value || "").trim().toLowerCase();
          if (!v) return null;
          if (v === "jp") return "ja";
          if (v === "mm") return "my";
          return v;
        };

        const renderMarkdown = (text) => {
          container.innerHTML = md ? md.render(text) : text;

          const checkboxes = container.querySelectorAll(
            'input[type="checkbox"]',
          );
          checkboxes.forEach((cb) => {
            cb.disabled = true;
            cb.setAttribute("aria-disabled", "true");
          });

          try {
            const rawMdPath = mdPath || "";
            const normalized = rawMdPath.startsWith("/")
              ? rawMdPath.substring(1)
              : rawMdPath;
            const lastSlash = normalized.lastIndexOf("/");
            const baseDir =
              lastSlash >= 0 ? normalized.substring(0, lastSlash + 1) : "";
            const isAbsolute = (u) =>
              /^(?:[a-z]+:)?\/\//i.test(u) ||
              u.startsWith("/") ||
              u.startsWith("data:");

            container.querySelectorAll("img[src]").forEach((img) => {
              const src = img.getAttribute("src");
              if (!src || isAbsolute(src)) return;
              img.setAttribute("src", "/" + baseDir + src);
            });

            container.querySelectorAll("a[href]").forEach((a) => {
              const href = a.getAttribute("href");
              if (!href || isAbsolute(href)) return;
              a.setAttribute("href", "/" + baseDir + href);
            });
          } catch (_) {}

          if (window.mermaid) {
            try {
              mermaid.initialize({ startOnLoad: false, theme: "default" });
              const blocks = container.querySelectorAll(
                "pre code.language-mermaid",
              );
              blocks.forEach((codeEl) => {
                const graphDef = codeEl.textContent.trim();
                const wrapper = document.createElement("div");
                wrapper.className = "mermaid my-4";
                wrapper.textContent = graphDef;
                const pre = codeEl.closest("pre");
                if (pre && pre.parentNode) {
                  pre.parentNode.replaceChild(wrapper, pre);
                }
              });
              mermaid.run({ querySelector: ".mermaid" });
            } catch (e) {
              console.warn("Mermaid render error:", e);
            }
          }

          if (window.hljs) {
            container.querySelectorAll("pre code").forEach((block) => {
              try {
                hljs.highlightElement(block);
              } catch (_) {}
            });
          }
        };

        const translateWithGoogleStudio = async (text) => {
          const sourceLang = normalizeLang(courseLanguage);
          const targetLang = normalizeLang(userLanguage);
          if (!targetLang || (sourceLang && sourceLang === targetLang)) {
            return text;
          }
          const tokenMeta = document.querySelector('meta[name="_csrf"]');
          const headerMeta = document.querySelector(
            'meta[name="_csrf_header"]',
          );
          const token = tokenMeta ? tokenMeta.getAttribute("content") : "";
          const headerName = headerMeta
            ? headerMeta.getAttribute("content")
            : "";

          const headers = { "Content-Type": "application/json" };
          if (token && headerName) {
            headers[headerName] = token;
          }

          const res = await fetch("/reader/translate", {
            method: "POST",
            headers,
            credentials: "same-origin",
            body: JSON.stringify({
              text,
              sourceLang,
              targetLang,
            }),
          });

          if (!res.ok) {
            const body = await res.text().catch(() => "");
            if (res.status === 503) {
              throw new Error("TRANSLATE_MISSING_API_KEY");
            }
            throw new Error(
              `HTTP ${res.status}${body ? " " + body.slice(0, 300) : ""}`,
            );
          }
          const out = await res.text();
          const trimmed = (out || "").trim();
          if (!trimmed) {
            throw new Error("TRANSLATE_EMPTY");
          }
          return trimmed;
        };

        if (mdTranslateBtn) {
          mdTranslateBtn.setAttribute("aria-label", i18n.translate);
          mdTranslateBtn.setAttribute("title", i18n.translate);
          if (mdTranslateBtnLabel)
            mdTranslateBtnLabel.textContent = i18n.translate;
          mdTranslateBtn.addEventListener("click", async () => {
            if (!rawMarkdownText) return;
            if (err) err.classList.add("hidden");
            if (translatedMarkdownText) {
              if (showingTranslated) {
                renderMarkdown(rawMarkdownText);
                showingTranslated = false;
                syncTranslateBtnState();
              } else {
                renderMarkdown(translatedMarkdownText);
                showingTranslated = true;
                syncTranslateBtnState();
              }
              return;
            }
            mdTranslateBtn.disabled = true;
            translateLoading = true;
            syncTranslateBtnState();
            try {
              const translated =
                await translateWithGoogleStudio(rawMarkdownText);
              translatedMarkdownText = translated;
              renderMarkdown(translatedMarkdownText);
              showingTranslated = true;
              syncTranslateBtnState();
            } catch (e) {
              if (e && e.message === "TRANSLATE_MISSING_API_KEY") {
                err.textContent = i18n.translateMissingApiKey;
              } else {
                err.textContent =
                  i18n.translateFailedPrefix +
                  (e && typeof e.message === "string" ? e.message : String(e));
              }
              err.classList.remove("hidden");
            } finally {
              mdTranslateBtn.disabled = false;
              translateLoading = false;
              syncTranslateBtnState();
            }
          });
          syncTranslateBtnState();
        }

        // Prefer controller endpoint to avoid static resource 404s during dev
        const apiUrl =
          courseId && ch && sc
            ? `/reader/md?courseId=${encodeURIComponent(
                courseId,
              )}&ch=${encodeURIComponent(ch)}&sc=${encodeURIComponent(sc)}`
            : null;

        // Fallback to static path if apiUrl not available
        const staticUrl = mdPath
          ? mdPath.startsWith("/")
            ? mdPath
            : "/" + mdPath
          : null;
        const url = apiUrl || staticUrl;

        if (!url) {
          err.textContent = i18n.errorNoMarkdownPath;
          err.classList.remove("hidden");
          return;
        }

        // Prepare markdown-it renderer with sub/sup and math (KaTeX)
        const md = window.markdownit
          ? window.markdownit({
              html: true,
              linkify: true,
              breaks: false,
              highlight: function (str, lang) {
                try {
                  if (window.hljs) {
                    if (lang && hljs.getLanguage(lang)) {
                      return hljs.highlight(str, { language: lang }).value;
                    }
                    return hljs.highlightAuto(str).value;
                  }
                } catch (_) {}
                return "";
              },
            })
          : null;
        if (md) {
          try {
            md.use(window.markdownitSub);
          } catch (_) {}
          try {
            md.use(window.markdownitSup);
          } catch (_) {}
          try {
            md.use(window.texmath, {
              engine: window.katex,
              delimiters: "dollars", // $...$ and $$...$$
              katexOptions: { throwOnError: false },
            });
          } catch (_) {}
          try {
            // Enable GitHub-style task list checkboxes (e.g. "- [ ]" / "- [x]")
            md.use(window.markdownitTaskLists, {
              enabled: true,
              label: true,
              labelAfter: true,
            });
          } catch (_) {}
        }

        fetch(url, { cache: "no-cache" })
          .then((r) => {
            if (!r.ok) {
              const e = new Error("MD_LOAD_FAILED");
              e.status = r.status;
              throw e;
            }
            return r.text();
          })
          .then((text) => {
            rawMarkdownText = text;
            translatedMarkdownText = null;
            showingTranslated = false;
            translateLoading = false;
            syncTranslateBtnState();
            renderMarkdown(text);

            // No subchapter tab scrolling (tabs removed)

            // Persistent drawer: visible by default, user can hide it
            const drawer = document.getElementById("subDrawer");
            const backdrop = document.getElementById("drawerBackdrop");
            const openBtn = document.getElementById("openDrawerBtn");
            const closeBtn = document.getElementById("closeDrawerBtn");
            const STORAGE_KEY = "readerDrawerHidden";

            const scrollLock = { locked: false, y: 0 };
            const lockScroll = () => {
              if (scrollLock.locked) return;
              scrollLock.locked = true;
              scrollLock.y = window.scrollY || 0;
              document.documentElement.style.overflow = "hidden";
              document.body.style.overflow = "hidden";
              document.body.style.position = "fixed";
              document.body.style.top = `-${scrollLock.y}px`;
              document.body.style.left = "0";
              document.body.style.right = "0";
              document.body.style.width = "100%";
            };
            const unlockScroll = () => {
              if (!scrollLock.locked) return;
              scrollLock.locked = false;
              document.documentElement.style.overflow = "";
              document.body.style.overflow = "";
              document.body.style.position = "";
              document.body.style.top = "";
              document.body.style.left = "";
              document.body.style.right = "";
              document.body.style.width = "";
              window.scrollTo(0, scrollLock.y || 0);
            };

            const setHidden = (hidden) => {
              if (!drawer) return;
              if (hidden) {
                drawer.classList.add("-translate-x-full");
                if (backdrop) {
                  backdrop.classList.add("pointer-events-none");
                  backdrop.classList.remove("opacity-100");
                  backdrop.classList.add("opacity-0");
                }
                unlockScroll();
                if (openBtn)
                  openBtn.querySelector("span") &&
                    (openBtn.querySelector("span").textContent =
                      i18n.drawerShow);
              } else {
                drawer.classList.remove("-translate-x-full");
                if (backdrop) {
                  backdrop.classList.remove("pointer-events-none");
                  backdrop.classList.remove("opacity-0");
                  backdrop.classList.add("opacity-100");
                }
                lockScroll();
                if (openBtn)
                  openBtn.querySelector("span") &&
                    (openBtn.querySelector("span").textContent =
                      i18n.drawerHide);
              }
              try {
                localStorage.setItem(STORAGE_KEY, hidden ? "1" : "0");
              } catch (_) {}
            };

            // Initialize state (default hidden)
            let hidden = true;
            setHidden(true);

            const toggleDrawer = () => {
              hidden = !hidden;
              setHidden(hidden);
            };
            openBtn && openBtn.addEventListener("click", toggleDrawer);
            closeBtn &&
              closeBtn.addEventListener("click", () => setHidden(true));
            backdrop &&
              backdrop.addEventListener("click", () => setHidden(true));
            window.addEventListener("beforeunload", unlockScroll);

            // Drawer accordion: only one chapter open at a time
            const chapterButtons = Array.from(
              document.querySelectorAll("#subDrawer .chapter-toggle"),
            );
            const panels = Array.from(
              document.querySelectorAll("#subDrawer .drawer-acc"),
            );
            const syncIcons = () => {
              chapterButtons.forEach((btn, idx) => {
                const icon = btn.querySelector(".acc-icon");
                const isOpen = panels[idx]?.classList.contains("open");
                btn.setAttribute("aria-expanded", String(!!isOpen));
                if (icon)
                  icon.style.transform = isOpen
                    ? "rotate(180deg)"
                    : "rotate(0deg)";
              });
            };
            const closeAll = () => {
              panels.forEach((p) => p.classList.remove("open"));
            };
            chapterButtons.forEach((btn, idx) => {
              btn.addEventListener("click", () => {
                const panel = panels[idx];
                const willOpen = !panel.classList.contains("open");
                closeAll();
                if (willOpen) panel.classList.add("open");
                syncIcons();
              });
            });
            // Initial sync for server-rendered open chapter
            syncIcons();
          })
          .catch((e) => {
            if (e && e.message === "MD_LOAD_FAILED") {
              const status =
                typeof e.status === "number" ? String(e.status) : "";
              err.textContent = i18n.errorLoadFailedPrefix + status;
            } else {
              err.textContent =
                e && typeof e.message === "string" ? e.message : String(e);
            }
            err.classList.remove("hidden");
          });

        const isTypingTarget = (t) => {
          if (!t) return false;
          const tag = (t.tagName || "").toLowerCase();
          if (tag === "input" || tag === "textarea" || tag === "select") {
            return true;
          }
          return !!t.isContentEditable;
        };

        const openNavLink = (el) => {
          if (!el) return false;
          if ((el.getAttribute("aria-disabled") || "").toLowerCase() === "true")
            return false;
          const href = el.getAttribute("href");
          if (!href) return false;
          window.location.assign(href);
          return true;
        };

        document.addEventListener("keydown", (e) => {
          if (!e || e.defaultPrevented) return;
          if (e.ctrlKey || e.metaKey || e.altKey) return;
          if (isTypingTarget(e.target)) return;

          const prev = document.getElementById("readerPrevPage");
          const next = document.getElementById("readerNextPage");

          if (e.key === "ArrowLeft" || e.key === "PageUp") {
            if (openNavLink(prev)) e.preventDefault();
          } else if (e.key === "ArrowRight" || e.key === "PageDown") {
            if (openNavLink(next)) e.preventDefault();
          }
        });
      })();
    </script>
    <script src="/js/navbar.js"></script>
  </body>
</html>
