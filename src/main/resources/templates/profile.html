<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="#{profile.pageTitle}">MYAN MYAN LEARN - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/tailwind-config.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .show {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
      }
    </style>
  </head>

  <body class="min-h-screen font-sans text-gray-800 flex flex-col">
    <nav th:replace="fragments/navbar :: appNavbar(#{nav.profile})"></nav>

    <!-- Main Content -->
    <main class="flex-1 pt-28 pb-16">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between mb-6 gap-4">
          <div class="min-w-0">
            <h1 class="text-white text-3xl sm:text-4xl font-extrabold">
              <span th:text="#{nav.profile}">Profile</span>
            </h1>
          </div>
          <a
            th:href="@{/home}"
            href="/home"
            class="flex items-center gap-2 text-white/80 hover:text-white transition bg-white/10 hover:bg-white/15 px-3 py-2 rounded-lg no-underline flex-shrink-0"
          >
            <i class="fas fa-arrow-left text-xs"></i>
            <span th:text="#{reader.back}">Back</span>
          </a>
        </div>

        <!-- Profile Header -->
        <div
          class="bg-white/10 border border-white/10 rounded-2xl p-6 sm:p-8 mb-8"
        >
          <div
            class="flex flex-col md:flex-row items-center md:items-start gap-6"
          >
            <!-- Profile Picture -->
            <div class="relative">
              <div class="w-32">
                <div class="relative w-32 h-32 rounded-2xl shadow-2xl">
                  <div class="absolute inset-0 rounded-2xl overflow-hidden">
                    <img
                      th:if="${userProfileImage != null and !#strings.isEmpty(userProfileImage)}"
                      th:src="${userProfileImage}"
                      class="w-full h-full object-cover"
                      alt="Profile photo"
                    />
                    <div
                      th:if="${userProfileImage == null or #strings.isEmpty(userProfileImage)}"
                      class="w-32 h-32 rounded-2xl bg-gradient-to-br from-primary-500 to-secondary-600 flex items-center justify-center text-white font-bold text-4xl"
                    >
                      <span th:text="${userInitials ?: 'U'}">U</span>
                    </div>
                  </div>
                  <div
                    id="profilePhotoMenuWrap"
                    class="absolute bottom-2 right-2 z-30"
                  >
                    <button
                      id="profilePhotoMenuBtn"
                      type="button"
                      class="w-9 h-9 rounded-xl bg-black/35 hover:bg-black/45 border border-white/15 backdrop-blur-md flex items-center justify-center text-white transition"
                      th:title="#{profile.photo.edit}"
                      title="Edit Photo"
                    >
                      <i class="fas fa-pen"></i>
                      <span class="sr-only" th:text="#{profile.photo.edit}"
                        >Edit Photo</span
                      >
                    </button>

                    <div
                      id="profilePhotoMenu"
                      class="hidden absolute bottom-full mb-2 right-0 z-40 w-44 rounded-xl border border-white/10 bg-slate-950/90 backdrop-blur-xl shadow-2xl overflow-hidden origin-bottom-right"
                      role="menu"
                      aria-orientation="vertical"
                    >
                      <button
                        id="profilePhotoUploadAction"
                        type="button"
                        class="w-full text-left px-3 py-2 text-sm text-white/90 hover:bg-white/10 transition flex items-center gap-2"
                        role="menuitem"
                      >
                        <i class="fas fa-upload text-white/70 w-4"></i>
                        <span
                          th:text="${userProfileImage != null and !#strings.isEmpty(userProfileImage)} ? #{profile.photo.change} : #{profile.photo.upload}"
                          >Upload Photo</span
                        >
                      </button>

                      <form
                        th:action="@{/profile/image/delete}"
                        method="post"
                        th:attr="data-confirm=#{profile.photo.removeConfirm}"
                        onsubmit="
                          return confirm(
                            this.getAttribute('data-confirm') ||
                              'Remove photo?',
                          );
                        "
                      >
                        <input
                          type="hidden"
                          th:name="${_csrf.parameterName}"
                          th:value="${_csrf.token}"
                        />
                        <button
                          type="submit"
                          class="w-full text-left px-3 py-2 text-sm text-white/90 hover:bg-white/10 transition flex items-center gap-2"
                          role="menuitem"
                          th:disabled="${userProfileImage == null or #strings.isEmpty(userProfileImage)}"
                          th:classappend="${userProfileImage == null or #strings.isEmpty(userProfileImage)} ? 'opacity-50 cursor-not-allowed hover:bg-transparent' : ''"
                          th:title="#{profile.photo.remove}"
                          title="Remove Photo"
                        >
                          <i class="fas fa-trash text-white/70 w-4"></i>
                          <span th:text="#{profile.photo.remove}"
                            >Remove Photo</span
                          >
                        </button>
                      </form>
                    </div>

                    <form
                      th:action="@{/profile/image}"
                      method="post"
                      enctype="multipart/form-data"
                      class="hidden"
                    >
                      <input
                        type="hidden"
                        th:name="${_csrf.parameterName}"
                        th:value="${_csrf.token}"
                      />
                      <input
                        id="profileImageInput"
                        name="image"
                        type="file"
                        accept="image/png,image/jpeg,image/webp,image/gif"
                        class="hidden"
                      />
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Info -->
            <div class="flex-1 text-center md:text-left">
              <h1
                class="text-3xl font-bold text-white mb-2"
                th:text="${userFullName ?: username ?: 'User'}"
              ></h1>
              <p
                class="text-white/80 text-lg mb-4"
                th:text="${userEmail ?: 'user@example.com'}"
              ></p>

              <!-- Status Badges -->
              <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                <span
                  class="px-3 py-1 bg-primary-500/20 text-primary-300 rounded-full text-sm font-medium border border-primary-500/30"
                  th:classappend="${userEmailVerified ? 'bg-green-500/20 text-green-300 border-green-500/30' : 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30'}"
                >
                  <i
                    class="fas fa-envelope mr-1"
                    th:classappend="${userEmailVerified ? 'fa-check' : 'fa-exclamation'}"
                  ></i>
                  <span
                    th:text="${userEmailVerified} ? #{profile.badge.emailVerified} : #{profile.badge.emailPending}"
                  ></span>
                </span>
                <span
                  class="px-3 py-1 bg-secondary-500/20 text-secondary-300 rounded-full text-sm font-medium border border-secondary-500/30"
                  th:classappend="${userActive ? 'bg-green-500/20 text-green-300 border-green-500/30' : 'bg-red-500/20 text-red-300 border-red-500/30'}"
                >
                  <i
                    class="fas fa-user mr-1"
                    th:classappend="${userActive ? 'fa-check' : 'fa-times'}"
                  ></i>
                  <span
                    th:text="${userActive} ? #{profile.badge.active} : #{profile.badge.inactive}"
                  ></span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Content Grid -->
        <div class="space-y-8">
          <!-- Personal Information -->
          <div>
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
              <i class="fas fa-user-circle mr-3 text-primary-400"></i>
              <span th:text="#{profile.section.personalInformation}"
                >Personal Information</span
              >
            </h2>

            <div
              class="bg-white/10 border border-white/10 rounded-2xl overflow-hidden"
            >
              <div class="divide-y divide-white/10">
                <div class="p-5 sm:p-6">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-id-card text-primary-400"></i>
                      <span th:text="#{profile.field.firstName}"
                        >First Name</span
                      >
                    </div>
                    <div class="text-white text-base font-semibold">
                      <span
                        th:text="${userFirstName} ?: #{profile.value.notProvided}"
                        data-first-name="${userFirstName ?: ''}"
                        >Not provided</span
                      >
                    </div>
                  </div>
                </div>

                <div class="p-5 sm:p-6">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-id-card-clip text-secondary-400"></i>
                      <span th:text="#{profile.field.lastName}">Last Name</span>
                    </div>
                    <div class="text-white text-base font-semibold">
                      <span
                        th:text="${userLastName} ?: #{profile.value.notProvided}"
                        data-last-name="${userLastName ?: ''}"
                        >Not provided</span
                      >
                    </div>
                  </div>
                </div>

                <div class="p-5 sm:p-6">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-envelope text-primary-400"></i>
                      <span th:text="#{profile.field.emailAddress}"
                        >Email Address</span
                      >
                    </div>
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                      <span
                        class="text-white text-base font-semibold flex-1 min-w-0 truncate"
                        th:text="${userEmail} ?: #{profile.value.notProvided}"
                        th:attr="data-email=${userEmail ?: ''}"
                        >Not provided</span
                      >
                      <span
                        class="shrink-0 px-2.5 py-1 rounded-full text-xs font-semibold border"
                        th:classappend="${userEmailVerified ? 'bg-green-500/20 text-green-300 border-green-500/30' : 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30'}"
                      >
                        <i
                          class="fas mr-1"
                          th:classappend="${userEmailVerified ? 'fa-check' : 'fa-exclamation'}"
                        ></i>
                        <span
                          th:text="${userEmailVerified} ? #{profile.badge.verified} : #{profile.badge.pending}"
                        ></span>
                      </span>
                    </div>
                  </div>
                </div>

                <div class="p-5 sm:p-6">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-at text-secondary-400"></i>
                      <span th:text="#{profile.field.username}">Username</span>
                    </div>
                    <div class="text-white text-base font-semibold">
                      <span
                        th:text="${username} ?: #{profile.value.notProvided}"
                        >Not provided</span
                      >
                    </div>
                  </div>
                </div>

                <div class="p-5 sm:p-6">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-user-tag text-primary-400"></i>
                      <span th:text="#{profile.field.role}">Role</span>
                    </div>
                    <div class="text-white text-base font-semibold">
                      <span
                        th:text="${userRoleLabel} ?: #{profile.value.notProvided}"
                        >Not provided</span
                      >
                    </div>
                  </div>
                </div>

                <div class="p-5 sm:p-6" th:if="${isStudent}">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-chalkboard text-secondary-400"></i>
                      <span th:text="#{profile.field.currentClass}"
                        >Current Class</span
                      >
                    </div>
                    <div class="text-white text-base font-semibold">
                      <span
                        th:text="${userCurrentClass} ?: #{profile.value.notProvided}"
                        >Not provided</span
                      >
                    </div>
                  </div>
                </div>

                <div class="p-5 sm:p-6" th:if="${isStudent}">
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"
                  >
                    <div
                      class="text-white/70 text-sm font-medium flex items-center gap-2 sm:w-40 shrink-0"
                    >
                      <i class="fas fa-calendar-alt text-green-400"></i>
                      <span th:text="#{profile.field.schoolYear}"
                        >School Year</span
                      >
                    </div>
                    <div class="text-white text-base font-semibold">
                      <span
                        th:text="${userSchoolYear} ?: #{profile.value.notProvided}"
                        >Not provided</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Name Section -->
        <div
          class="mt-8 bg-white/10 border border-white/10 rounded-2xl p-6 sm:p-8"
        >
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-white flex items-center">
              <i class="fas fa-user-edit mr-3 text-primary-400"></i>
              <span th:text="#{profile.changeName.title}">Change Name</span>
            </h3>
            <button
              id="toggleNameForm"
              class="px-6 py-3 bg-gradient-to-r from-primary-500 to-secondary-600 hover:from-primary-600 hover:to-secondary-700 text-white font-medium rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-xl"
            >
              <i class="fas fa-edit mr-2"></i>
              <span th:text="#{profile.changeName.edit}">Edit Name</span>
            </button>
          </div>

          <form id="changeNameForm" class="space-y-6 hidden">
            <input type="hidden" id="csrfToken" th:value="${_csrf.token}" />
            <input
              type="hidden"
              id="csrfHeader"
              th:value="${_csrf.headerName}"
            />
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
              <div class="flex-1">
                <label
                  for="newFirstName"
                  class="block text-white/80 text-sm font-medium mb-2"
                  ><span th:text="#{profile.field.firstName}"
                    >First Name</span
                  ></label
                >
                <input
                  type="text"
                  id="newFirstName"
                  name="newFirstName"
                  class="w-full bg-white/10 backdrop-blur-md rounded-xl px-4 py-3 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300"
                  th:placeholder="#{profile.changeName.placeholder.first}"
                  placeholder="Enter your first name"
                  required
                />
              </div>
              <div class="flex-1">
                <label
                  for="newLastName"
                  class="block text-white/80 text-sm font-medium mb-2"
                  ><span th:text="#{profile.field.lastName}"
                    >Last Name</span
                  ></label
                >
                <input
                  type="text"
                  id="newLastName"
                  name="newLastName"
                  class="w-full bg-white/10 backdrop-blur-md rounded-xl px-4 py-3 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300"
                  th:placeholder="#{profile.changeName.placeholder.last}"
                  placeholder="Enter your last name"
                  required
                />
              </div>
            </div>

            <div class="flex gap-4">
              <button
                type="submit"
                class="w-full px-6 py-3 bg-gradient-to-r from-primary-500 to-secondary-600 hover:from-primary-600 hover:to-secondary-700 text-white font-medium rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-xl"
              >
                <i class="fas fa-save mr-2"></i>
                <span th:text="#{profile.changeName.update}">Update Name</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Change Password Section -->
        <div
          class="mt-8 bg-white/10 border border-white/10 rounded-2xl p-6 sm:p-8"
        >
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-white flex items-center">
              <i class="fas fa-lock mr-3 text-green-400"></i>
              <span th:text="#{profile.changePassword.title}"
                >Change Password</span
              >
            </h3>
            <button
              id="togglePasswordForm"
              class="px-6 py-3 bg-gradient-to-r from-green-500 to-primary-600 hover:from-green-600 hover:to-primary-700 text-white font-medium rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-xl"
            >
              <i class="fas fa-key mr-2"></i>
              <span th:text="#{profile.changePassword.change}"
                >Change Password</span
              >
            </button>
          </div>

          <form id="changePasswordForm" class="space-y-6 hidden">
            <div>
              <label
                for="oldPassword"
                class="block text-white/80 text-sm font-medium mb-2"
                ><span th:text="#{profile.changePassword.current}"
                  >Current Password</span
                ></label
              >
              <div class="relative">
                <input
                  type="password"
                  id="oldPassword"
                  name="oldPassword"
                  class="w-full bg-white/10 backdrop-blur-md rounded-xl px-4 py-3 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300"
                  th:placeholder="#{profile.changePassword.placeholder.current}"
                  placeholder="Enter your current password"
                  required
                />
                <button
                  type="button"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors duration-200"
                  onclick="togglePasswordVisibility('oldPassword')"
                >
                  <i class="fas fa-eye" id="oldPasswordToggle"></i>
                </button>
              </div>
            </div>

            <div>
              <label
                for="newPassword"
                class="block text-white/80 text-sm font-medium mb-2"
                ><span th:text="#{profile.changePassword.new}"
                  >New Password</span
                ></label
              >
              <div class="relative">
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  class="w-full bg-white/10 backdrop-blur-md rounded-xl px-4 py-3 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300"
                  th:placeholder="#{profile.changePassword.placeholder.new}"
                  placeholder="Enter your new password"
                  required
                  minlength="8"
                />
                <button
                  type="button"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors duration-200"
                  onclick="togglePasswordVisibility('newPassword')"
                >
                  <i class="fas fa-eye" id="newPasswordToggle"></i>
                </button>
              </div>
              <p class="text-white/60 text-xs mt-1">
                <span th:text="#{profile.changePassword.hint.minLength}"
                  >Password must be at least 8 characters long</span
                >
              </p>
            </div>

            <div>
              <label
                for="confirmPassword"
                class="block text-white/80 text-sm font-medium mb-2"
                ><span th:text="#{profile.changePassword.confirm}"
                  >Confirm New Password</span
                ></label
              >
              <div class="relative">
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  class="w-full bg-white/10 backdrop-blur-md rounded-xl px-4 py-3 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-300"
                  th:placeholder="#{profile.changePassword.placeholder.confirm}"
                  placeholder="Confirm your new password"
                  required
                />
                <button
                  type="button"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors duration-200"
                  onclick="togglePasswordVisibility('confirmPassword')"
                >
                  <i class="fas fa-eye" id="confirmPasswordToggle"></i>
                </button>
              </div>
            </div>

            <div class="flex gap-4">
              <button
                type="submit"
                class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-primary-600 hover:from-green-600 hover:to-primary-700 text-white font-medium rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-xl"
              >
                <i class="fas fa-save mr-2"></i>
                <span th:text="#{profile.changePassword.change}"
                  >Change Password</span
                >
              </button>
            </div>
          </form>
        </div>

        <!-- Delete Account Section -->
        <div
          class="mt-12 bg-red-500/10 border border-red-500/20 rounded-2xl p-6 sm:p-8"
        >
          <div class="text-center">
            <div
              class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-red-300 mb-2">
              <span th:text="#{profile.deleteAccount.danger.title}"
                >Danger Zone</span
              >
            </h3>
            <p class="text-red-200/80 mb-6 max-w-2xl mx-auto">
              <span th:text="#{profile.deleteAccount.danger.desc}"
                >Once you delete your account, there is no going back. Please be
                certain. All your data will be permanently removed.</span
              >
            </p>
            <button
              id="deleteAccountBtn"
              class="px-8 py-4 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-xl border-2 border-red-500"
            >
              <i class="fas fa-trash mr-2"></i>
              <span th:text="#{profile.deleteAccount.button.open}"
                >Delete My Account</span
              >
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Delete Account Confirmation Modal -->
    <div
      id="deleteModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white/10 border border-white/10 rounded-2xl p-6 sm:p-8 max-w-md w-full"
      >
        <div class="text-center">
          <div
            class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-white mb-2">
            <span th:text="#{profile.deleteAccount.modal.title}"
              >Delete Account</span
            >
          </h3>
          <p class="text-white/80 mb-6">
            <span th:text="#{profile.deleteAccount.modal.desc}"
              >Are you sure you want to delete your account? This action cannot
              be undone and all your data will be permanently removed.</span
            >
          </p>

          <!-- Confirmation Text Input -->
          <div class="mb-6">
            <label
              for="deleteConfirmation"
              class="block text-white/80 text-sm font-medium mb-2"
              th:utext="#{profile.deleteAccount.modal.confirmLabel}"
              >Type <span class="font-bold text-red-300">delete</span> to
              confirm:</label
            >
            <input
              type="text"
              id="deleteConfirmation"
              class="w-full px-4 py-3 bg-white/10 backdrop-blur-md rounded-xl text-white border border-white/20 focus:border-red-500/50 focus:ring-2 focus:ring-red-500/20 focus:outline-none transition-all duration-300"
              th:placeholder="#{profile.deleteAccount.modal.placeholder}"
              placeholder="Type 'delete' here"
            />
            <div
              id="confirmationError"
              class="text-red-400 text-sm mt-2 hidden"
            >
              <span th:text="#{profile.deleteAccount.modal.error}"
                >Please type "delete" exactly to confirm account deletion.</span
              >
            </div>
          </div>

          <div class="flex gap-3">
            <button
              id="cancelDelete"
              class="flex-1 px-4 py-3 bg-white/20 backdrop-blur-md rounded-xl text-white font-medium transition-all duration-300 hover:bg-white/30 border border-white/30"
            >
              <span th:text="#{profile.deleteAccount.button.cancel}"
                >Cancel</span
              >
            </button>
            <button
              id="confirmDelete"
              class="flex-1 px-4 py-3 bg-red-500/20 backdrop-blur-md rounded-xl text-red-300 font-medium transition-all duration-300 hover:bg-red-500/30 border border-red-500/30 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <span th:text="#{profile.deleteAccount.button.confirm}"
                >Delete Account</span
              >
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      const CHANGE_NAME_LABEL_EDIT =
        /*[[#{profile.changeName.edit}]]*/ "Edit Name";
      const CHANGE_NAME_LABEL_CANCEL =
        /*[[#{profile.changeName.cancel}]]*/ "Cancel";
      const CHANGE_NAME_TOGGLE_EDIT_HTML =
        '<i class="fas fa-edit mr-2"></i>' + CHANGE_NAME_LABEL_EDIT;
      const CHANGE_NAME_TOGGLE_CANCEL_HTML =
        '<i class="fas fa-times mr-2"></i>' + CHANGE_NAME_LABEL_CANCEL;

      const CHANGE_NAME_MSG_REQUIRED =
        /*[[#{profile.changeName.msg.required}]]*/ "Both first name and last name are required!";
      const CHANGE_NAME_MSG_MIN_LENGTH =
        /*[[#{profile.changeName.msg.minLength}]]*/ "Names must be at least 2 characters long!";
      const CHANGE_NAME_MSG_MAX_LENGTH =
        /*[[#{profile.changeName.msg.maxLength}]]*/ "Names must be 50 characters or fewer!";
      const CHANGE_NAME_MSG_UPDATING =
        /*[[#{profile.changeName.msg.updating}]]*/ "Updating...";
      const CHANGE_NAME_MSG_SUCCESS =
        /*[[#{profile.changeName.msg.success}]]*/ "Name updated successfully!";
      const CHANGE_NAME_MSG_FAIL =
        /*[[#{profile.changeName.msg.fail}]]*/ "Failed to update name!";
      const CHANGE_NAME_MSG_ERROR =
        /*[[#{profile.changeName.msg.error}]]*/ "An error occurred while updating name!";
      const CHANGE_NAME_MSG_CSRF =
        /*[[#{profile.changeName.msg.csrf}]]*/ "Request blocked (CSRF). Please refresh and try again.";
      const CHANGE_NAME_MSG_HTTP_FAIL =
        /*[[#{profile.changeName.msg.httpFail}]]*/ "Request failed. Please try again.";

      const CHANGE_PASSWORD_LABEL_CHANGE =
        /*[[#{profile.changePassword.change}]]*/ "Change Password";
      const CHANGE_PASSWORD_LABEL_CANCEL =
        /*[[#{profile.changePassword.cancel}]]*/ "Cancel";
      const CHANGE_PASSWORD_TOGGLE_CHANGE_HTML =
        '<i class="fas fa-key mr-2"></i>' + CHANGE_PASSWORD_LABEL_CHANGE;
      const CHANGE_PASSWORD_TOGGLE_CANCEL_HTML =
        '<i class="fas fa-times mr-2"></i>' + CHANGE_PASSWORD_LABEL_CANCEL;

      const CHANGE_PASSWORD_MSG_MISMATCH =
        /*[[#{profile.changePassword.msg.mismatch}]]*/ "New passwords do not match!";
      const CHANGE_PASSWORD_MSG_MIN_LENGTH =
        /*[[#{profile.changePassword.msg.minLength}]]*/ "New password must be at least 8 characters long!";
      const CHANGE_PASSWORD_MSG_DIFFERENT =
        /*[[#{profile.changePassword.msg.different}]]*/ "New password must be different from current password!";
      const CHANGE_PASSWORD_MSG_SUCCESS =
        /*[[#{profile.changePassword.msg.success}]]*/ "Password changed successfully!";
      const CHANGE_PASSWORD_MSG_FAIL =
        /*[[#{profile.changePassword.msg.fail}]]*/ "Failed to change password!";
      const CHANGE_PASSWORD_MSG_ERROR =
        /*[[#{profile.changePassword.msg.error}]]*/ "An error occurred while changing password!";
      const CHANGE_PASSWORD_MSG_CHANGING =
        /*[[#{profile.changePassword.msg.changing}]]*/ "Changing...";
      const CHANGE_PASSWORD_MSG_CSRF =
        /*[[#{profile.changePassword.msg.csrf}]]*/ "Request blocked (CSRF). Please refresh and try again.";
      const CHANGE_PASSWORD_MSG_HTTP_FAIL =
        /*[[#{profile.changePassword.msg.httpFail}]]*/ "Request failed. Please try again.";

      const DELETE_ACCOUNT_LABEL_CONFIRM =
        /*[[#{profile.deleteAccount.button.confirm}]]*/ "Delete Account";
      const DELETE_ACCOUNT_LABEL_DELETING =
        /*[[#{profile.deleteAccount.msg.deleting}]]*/ "Deleting...";
      const DELETE_ACCOUNT_BTN_CONFIRM_HTML =
        '<i class="fas fa-trash mr-2"></i>' + DELETE_ACCOUNT_LABEL_CONFIRM;

      const DELETE_ACCOUNT_MSG_FAIL =
        /*[[#{profile.deleteAccount.msg.fail}]]*/ "Failed to delete account. Please try again.";
      const DELETE_ACCOUNT_MSG_ERROR =
        /*[[#{profile.deleteAccount.msg.error}]]*/ "An error occurred. Please try again.";
      const DELETE_ACCOUNT_MSG_CSRF =
        /*[[#{profile.deleteAccount.msg.csrf}]]*/ "Request blocked (CSRF). Please refresh and try again.";

      document.addEventListener("DOMContentLoaded", function () {
        const profileImageInput = document.getElementById("profileImageInput");
        if (profileImageInput) {
          profileImageInput.addEventListener("change", function () {
            if (this.files && this.files.length > 0) {
              this.form.submit();
            }
          });
        }

        const profilePhotoMenuWrap = document.getElementById(
          "profilePhotoMenuWrap",
        );
        const profilePhotoMenuBtn = document.getElementById(
          "profilePhotoMenuBtn",
        );
        const profilePhotoMenu = document.getElementById("profilePhotoMenu");
        const profilePhotoUploadAction = document.getElementById(
          "profilePhotoUploadAction",
        );

        function closeProfilePhotoMenu() {
          if (profilePhotoMenu) {
            profilePhotoMenu.classList.add("hidden");
          }
        }

        function toggleProfilePhotoMenu() {
          if (!profilePhotoMenu) return;
          profilePhotoMenu.classList.toggle("hidden");
        }

        if (profilePhotoMenuBtn && profilePhotoMenu) {
          profilePhotoMenuBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            toggleProfilePhotoMenu();
          });
        }

        if (profilePhotoUploadAction && profileImageInput) {
          profilePhotoUploadAction.addEventListener("click", function (e) {
            e.preventDefault();
            closeProfilePhotoMenu();
            profileImageInput.click();
          });
        }

        document.addEventListener("click", function (e) {
          if (!profilePhotoMenuWrap || !profilePhotoMenu) return;
          if (!profilePhotoMenu.classList.contains("hidden")) {
            if (!profilePhotoMenuWrap.contains(e.target)) {
              closeProfilePhotoMenu();
            }
          }
        });

        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeProfilePhotoMenu();
          }
        });

        const deleteBtn = document.getElementById("deleteAccountBtn");
        const deleteModal = document.getElementById("deleteModal");
        const cancelBtn = document.getElementById("cancelDelete");
        const confirmBtn = document.getElementById("confirmDelete");
        const confirmationInput = document.getElementById("deleteConfirmation");
        const confirmationError = document.getElementById("confirmationError");

        deleteBtn.addEventListener("click", function () {
          deleteModal.classList.remove("hidden");
          confirmationInput.value = "";
          confirmBtn.disabled = true;
          confirmationError.classList.add("hidden");
        });

        cancelBtn.addEventListener("click", function () {
          deleteModal.classList.add("hidden");
          confirmationInput.value = "";
          confirmBtn.disabled = true;
          confirmationError.classList.add("hidden");
        });

        confirmationInput.addEventListener("input", function () {
          const inputValue = this.value.toLowerCase().trim();
          const deleteText = "delete";

          if (inputValue === deleteText) {
            confirmBtn.disabled = false;
            confirmationError.classList.add("hidden");
          } else {
            confirmBtn.disabled = true;
            if (inputValue.length > 0 && inputValue !== deleteText) {
              confirmationError.classList.remove("hidden");
            } else {
              confirmationError.classList.add("hidden");
            }
          }
        });

        confirmBtn.addEventListener("click", function () {
          const inputValue = confirmationInput.value.toLowerCase().trim();

          if (inputValue !== "delete") {
            confirmationError.classList.remove("hidden");
            return;
          }

          confirmBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>' +
            DELETE_ACCOUNT_LABEL_DELETING;
          confirmBtn.disabled = true;

          const csrfTokenEl = document.getElementById("csrfToken");
          const csrfHeaderEl = document.getElementById("csrfHeader");
          const csrfToken = csrfTokenEl ? csrfTokenEl.value : "";
          const csrfHeader = csrfHeaderEl ? csrfHeaderEl.value : "X-CSRF-TOKEN";
          const headers = {
            "Content-Type": "application/json",
          };
          if (csrfToken) {
            headers[csrfHeader] = csrfToken;
          }

          fetch("/profile/delete", {
            method: "DELETE",
            headers,
            credentials: "same-origin",
          })
            .then(async (response) => {
              const text = await response.text();
              try {
                return { response, data: JSON.parse(text) };
              } catch (e) {
                return {
                  response,
                  data: {
                    success: false,
                    message:
                      response.status === 403
                        ? DELETE_ACCOUNT_MSG_CSRF
                        : `${DELETE_ACCOUNT_MSG_FAIL} (${response.status})`,
                  },
                };
              }
            })
            .then(({ response, data }) => {
              if (response.ok && data && data.success) {
                window.location.href = "/login?deleted=true";
                return;
              }
              showMessage(
                (data && data.message) || DELETE_ACCOUNT_MSG_FAIL,
                "error",
              );
              confirmBtn.innerHTML = DELETE_ACCOUNT_BTN_CONFIRM_HTML;
              confirmBtn.disabled = false;
            })
            .catch(() => {
              showMessage(DELETE_ACCOUNT_MSG_ERROR, "error");
              confirmBtn.innerHTML = DELETE_ACCOUNT_BTN_CONFIRM_HTML;
              confirmBtn.disabled = false;
            });
        });

        deleteModal.addEventListener("click", function (e) {
          if (e.target === deleteModal) {
            deleteModal.classList.add("hidden");
          }
        });

        const changeNameForm = document.getElementById("changeNameForm");
        const toggleNameForm = document.getElementById("toggleNameForm");

        if (toggleNameForm) {
          toggleNameForm.addEventListener("click", function () {
            const form = document.getElementById("changeNameForm");
            if (form.classList.contains("hidden")) {
              form.classList.remove("hidden");
              this.innerHTML = CHANGE_NAME_TOGGLE_CANCEL_HTML;
              this.classList.remove(
                "from-primary-500",
                "to-secondary-600",
                "hover:from-primary-600",
                "hover:to-secondary-700",
              );
              this.classList.add(
                "from-red-500",
                "to-primary-600",
                "hover:from-red-600",
                "hover:to-primary-700",
              );
              var fn = document.querySelector("[data-first-name]");
              document.getElementById("newFirstName").value = fn
                ? fn.textContent
                : "";
              var ln = document.querySelector("[data-last-name]");
              document.getElementById("newLastName").value = ln
                ? ln.textContent
                : "";
            } else {
              form.classList.add("hidden");
              this.innerHTML = CHANGE_NAME_TOGGLE_EDIT_HTML;
              this.classList.remove(
                "from-red-500",
                "to-primary-600",
                "hover:from-red-600",
                "hover:to-primary-700",
              );
              this.classList.add(
                "from-primary-500",
                "to-secondary-600",
                "hover:from-primary-600",
                "hover:to-secondary-700",
              );
              clearNameForm();
            }
          });
        }

        if (changeNameForm) {
          changeNameForm.addEventListener("submit", function (e) {
            e.preventDefault();
            handleNameChange();
          });
        }

        const changePasswordForm =
          document.getElementById("changePasswordForm");
        const togglePasswordForm =
          document.getElementById("togglePasswordForm");

        if (togglePasswordForm) {
          togglePasswordForm.addEventListener("click", function () {
            const form = document.getElementById("changePasswordForm");
            if (form.classList.contains("hidden")) {
              form.classList.remove("hidden");
              this.innerHTML = CHANGE_PASSWORD_TOGGLE_CANCEL_HTML;
              this.classList.remove(
                "from-green-500",
                "to-primary-600",
                "hover:from-green-600",
                "hover:to-primary-700",
              );
              this.classList.add(
                "from-red-500",
                "to-primary-600",
                "hover:from-red-600",
                "hover:to-primary-700",
              );
            } else {
              form.classList.add("hidden");
              this.innerHTML = CHANGE_PASSWORD_TOGGLE_CHANGE_HTML;
              this.classList.remove(
                "from-red-500",
                "to-primary-600",
                "hover:from-red-600",
                "hover:to-primary-700",
              );
              this.classList.add(
                "from-green-500",
                "to-primary-600",
                "hover:from-green-600",
                "hover:to-primary-700",
              );
              clearPasswordForm();
            }
          });
        }

        if (changePasswordForm) {
          changePasswordForm.addEventListener("submit", function (e) {
            e.preventDefault();
            handlePasswordChange();
          });
        }
      });

      function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const toggle = document.getElementById(fieldId + "Toggle");

        if (field.type === "password") {
          field.type = "text";
          toggle.classList.remove("fa-eye");
          toggle.classList.add("fa-eye-slash");
        } else {
          field.type = "password";
          toggle.classList.remove("fa-eye-slash");
          toggle.classList.add("fa-eye");
        }
      }

      function handlePasswordChange() {
        const oldPassword = document.getElementById("oldPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        if (newPassword !== confirmPassword) {
          showMessage(CHANGE_PASSWORD_MSG_MISMATCH, "error");
          return;
        }

        if (newPassword.length < 8) {
          showMessage(CHANGE_PASSWORD_MSG_MIN_LENGTH, "error");
          return;
        }

        if (oldPassword === newPassword) {
          showMessage(CHANGE_PASSWORD_MSG_DIFFERENT, "error");
          return;
        }

        // Show loading state
        const submitBtn = document.querySelector(
          '#changePasswordForm button[type="submit"]',
        );
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>' +
          CHANGE_PASSWORD_MSG_CHANGING;
        submitBtn.disabled = true;

        const csrfTokenEl = document.getElementById("csrfToken");
        const csrfHeaderEl = document.getElementById("csrfHeader");
        const csrfToken = csrfTokenEl ? csrfTokenEl.value : "";
        const csrfHeader = csrfHeaderEl ? csrfHeaderEl.value : "X-CSRF-TOKEN";
        const headers = {
          "Content-Type": "application/json",
        };
        if (csrfToken) {
          headers[csrfHeader] = csrfToken;
        }

        fetch("/profile/change-password", {
          method: "POST",
          headers,
          credentials: "same-origin",
          body: JSON.stringify({
            oldPassword: oldPassword,
            newPassword: newPassword,
          }),
        })
          .then(async (response) => {
            const text = await response.text();
            try {
              return JSON.parse(text);
            } catch (e) {
              return {
                success: false,
                message:
                  response.status === 403
                    ? CHANGE_PASSWORD_MSG_CSRF
                    : `${CHANGE_PASSWORD_MSG_HTTP_FAIL} (${response.status})`,
              };
            }
          })
          .then((data) => {
            if (data.success) {
              showMessage(CHANGE_PASSWORD_MSG_SUCCESS, "success");
              clearPasswordForm();
              const form = document.getElementById("changePasswordForm");
              const toggleBtn = document.getElementById("togglePasswordForm");
              form.classList.add("hidden");
              toggleBtn.innerHTML = CHANGE_PASSWORD_TOGGLE_CHANGE_HTML;
              toggleBtn.classList.remove(
                "from-red-500",
                "to-primary-600",
                "hover:from-red-600",
                "hover:to-primary-700",
              );
              toggleBtn.classList.add(
                "from-green-500",
                "to-primary-600",
                "hover:from-green-600",
                "hover:to-primary-700",
              );
            } else {
              showMessage(data.message || CHANGE_PASSWORD_MSG_FAIL, "error");
            }
          })
          .catch(() => {
            showMessage(CHANGE_PASSWORD_MSG_ERROR, "error");
          })
          .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          });
      }

      function handleNameChange() {
        const newFirstName = document
          .getElementById("newFirstName")
          .value.trim();
        const newLastName = document.getElementById("newLastName").value.trim();

        if (!newFirstName || !newLastName) {
          showMessage(CHANGE_NAME_MSG_REQUIRED, "error");
          return;
        }

        if (newFirstName.length < 2 || newLastName.length < 2) {
          showMessage(CHANGE_NAME_MSG_MIN_LENGTH, "error");
          return;
        }

        if (newFirstName.length > 50 || newLastName.length > 50) {
          showMessage(CHANGE_NAME_MSG_MAX_LENGTH, "error");
          return;
        }

        // Show loading state
        const submitBtn = document.querySelector(
          '#changeNameForm button[type="submit"]',
        );
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>' +
          CHANGE_NAME_MSG_UPDATING;
        submitBtn.disabled = true;

        const csrfTokenEl = document.getElementById("csrfToken");
        const csrfHeaderEl = document.getElementById("csrfHeader");
        const csrfToken = csrfTokenEl ? csrfTokenEl.value : "";
        const csrfHeader = csrfHeaderEl ? csrfHeaderEl.value : "X-CSRF-TOKEN";
        const headers = {
          "Content-Type": "application/json",
        };
        if (csrfToken) {
          headers[csrfHeader] = csrfToken;
        }

        fetch("/profile/change-name", {
          method: "POST",
          headers,
          body: JSON.stringify({
            firstName: newFirstName,
            lastName: newLastName,
          }),
        })
          .then(async (response) => {
            const text = await response.text();
            try {
              return JSON.parse(text);
            } catch (e) {
              return {
                success: false,
                message:
                  response.status === 403
                    ? CHANGE_NAME_MSG_CSRF
                    : `${CHANGE_NAME_MSG_HTTP_FAIL} (${response.status})`,
              };
            }
          })
          .then((data) => {
            if (data.success) {
              showMessage(CHANGE_NAME_MSG_SUCCESS, "success");
              clearNameForm();
              const form = document.getElementById("changeNameForm");
              const toggleBtn = document.getElementById("toggleNameForm");
              form.classList.add("hidden");
              toggleBtn.innerHTML = CHANGE_NAME_TOGGLE_EDIT_HTML;
              toggleBtn.classList.remove(
                "from-red-500",
                "to-primary-600",
                "hover:from-red-600",
                "hover:to-primary-700",
              );
              toggleBtn.classList.add(
                "from-primary-500",
                "to-secondary-600",
                "hover:from-primary-600",
                "hover:to-secondary-700",
              );
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } else {
              showMessage(data.message || CHANGE_NAME_MSG_FAIL, "error");
            }
          })
          .catch(() => {
            showMessage(CHANGE_NAME_MSG_ERROR, "error");
          })
          .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          });
      }

      function clearNameForm() {
        document.getElementById("newFirstName").value = "";
        document.getElementById("newLastName").value = "";
      }

      function clearPasswordForm() {
        document.getElementById("oldPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
      }

      function showMessage(message, type) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `fixed top-24 right-4 z-50 px-6 py-3 rounded-xl shadow-xl transition-all duration-300 ${
          type === "success"
            ? "bg-green-500 text-white"
            : "bg-red-500 text-white"
        }`;
        messageDiv.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${
            type === "success" ? "fa-check-circle" : "fa-exclamation-circle"
          } mr-2"></i>
          <span>${message}</span>
        </div>
      `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    </script>
    <script src="/js/navbar.js"></script>
  </body>
</html>
