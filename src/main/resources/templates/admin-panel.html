<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="#{adminPanel.pageTitle}">
      MYAN MYAN LEARN - Admin Panel
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/tailwind-config.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .show {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
      }
    </style>
  </head>
  <body class="min-h-screen font-sans text-gray-800 flex flex-col">
    <nav th:replace="fragments/navbar :: appNavbar(#{nav.adminPanel})"></nav>

    <main class="flex-1 pt-28 pb-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between gap-4 mb-6">
          <h1 class="text-white text-3xl sm:text-4xl font-extrabold">
            <span th:text="#{nav.adminPanel}">Admin Panel</span>
          </h1>
          <a
            th:href="@{/home}"
            href="/home"
            class="flex items-center gap-2 text-white/80 hover:text-white transition bg-white/10 hover:bg-white/15 px-3 py-2 rounded-lg no-underline flex-shrink-0"
          >
            <i class="fas fa-arrow-left text-xs"></i>
            <span th:text="#{reader.back}">Back</span>
          </a>
        </div>

        <section
          class="bg-white/10 border border-white/10 rounded-2xl backdrop-blur-xl min-h-[360px] overflow-hidden"
          th:with="section=${param.section != null ? param.section[0] : 'courses'}"
        >
          <div class="flex flex-col sm:flex-row min-h-[360px]">
            <aside class="sm:w-64 flex-shrink-0 p-2">
              <nav class="space-y-1">
                <a
                  th:href="@{/admin(section='courses')}"
                  href="/admin?section=courses"
                  th:classappend="${section == 'courses'} ? ' bg-white/15 border-white/20 text-white' : ' border-transparent'"
                  class="flex items-center gap-2 px-3 py-2 rounded-lg text-white/90 no-underline hover:bg-white/10 transition border text-sm"
                >
                  <div
                    th:classappend="${section == 'courses'} ? ' bg-white/15' : ''"
                    class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center"
                  >
                    <i class="fas fa-book text-sm"></i>
                  </div>
                  <div
                    class="flex-1 font-semibold"
                    th:text="#{adminPanel.courses}"
                  >
                    Courses Management
                  </div>
                </a>

                <a
                  th:if="${isAdmin}"
                  th:href="@{/admin(section='users')}"
                  href="/admin?section=users"
                  th:classappend="${section == 'users'} ? ' bg-white/15 border-white/20 text-white' : ' border-transparent'"
                  class="flex items-center gap-2 px-3 py-2 rounded-lg text-white/90 no-underline hover:bg-white/10 transition border text-sm"
                >
                  <div
                    th:classappend="${section == 'users'} ? ' bg-white/15' : ''"
                    class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center"
                  >
                    <i class="fas fa-users text-sm"></i>
                  </div>
                  <div
                    class="flex-1 font-semibold"
                    th:text="#{adminPanel.userManagement}"
                  >
                    User Management
                  </div>
                </a>

                <a
                  th:href="@{/admin(section='settings')}"
                  href="/admin?section=settings"
                  th:classappend="${section == 'settings'} ? ' bg-white/15 border-white/20 text-white' : ' border-transparent'"
                  class="flex items-center gap-2 px-3 py-2 rounded-lg text-white/90 no-underline hover:bg-white/10 transition border text-sm"
                >
                  <div
                    th:classappend="${section == 'settings'} ? ' bg-white/15' : ''"
                    class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center"
                  >
                    <i class="fas fa-gear text-sm"></i>
                  </div>
                  <div
                    class="flex-1 font-semibold"
                    th:text="#{adminPanel.settings}"
                  >
                    Settings
                  </div>
                </a>
              </nav>
            </aside>

            <div class="sm:hidden h-px bg-white/10"></div>
            <div
              class="hidden sm:block w-px bg-white/10 flex-shrink-0 my-4"
            ></div>

            <div class="flex-1 p-5 sm:p-6 min-w-0">
              <div th:if="${section == 'users' and isAdmin}" class="space-y-2">
                <h2 class="text-white text-2xl font-bold">
                  <span th:text="#{adminPanel.userManagement}"
                    >User Management</span
                  >
                </h2>
                <form
                  th:action="@{/admin}"
                  action="/admin"
                  method="get"
                  class="mt-3"
                >
                  <input type="hidden" name="section" value="users" />
                  <div
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-2"
                  >
                    <div
                      class="relative w-full sm:max-w-[360px] sm:flex-1 min-w-0"
                    >
                      <div
                        class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-white/60"
                      >
                        <i class="fas fa-magnifying-glass"></i>
                      </div>
                      <input
                        name="q"
                        th:value="${userQ}"
                        type="text"
                        placeholder="Search users..."
                        class="bg-white/10 text-white text-sm rounded-lg pl-9 pr-3 h-9 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 w-full"
                      />
                    </div>

                    <div class="relative w-full sm:w-[120px] flex-shrink-0">
                      <div
                        class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2 text-white/60"
                      >
                        <i class="fas fa-filter text-xs"></i>
                      </div>
                      <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2 text-white/60"
                      >
                        <i class="fas fa-chevron-down text-xs"></i>
                      </div>
                      <select
                        name="field"
                        class="appearance-none bg-white/10 text-white text-xs rounded-lg pl-7 pr-6 h-9 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 w-full cursor-pointer"
                      >
                        <option
                          value="name"
                          th:selected="${userField == null || userField == 'name'}"
                        >
                          Name
                        </option>
                        <option
                          value="username"
                          th:selected="${userField == 'username'}"
                        >
                          Username
                        </option>
                        <option
                          value="email"
                          th:selected="${userField == 'email'}"
                        >
                          Email
                        </option>
                      </select>
                    </div>

                    <div class="relative w-full sm:w-[104px] flex-shrink-0">
                      <div
                        class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2 text-white/60"
                      >
                        <i class="fas fa-users text-xs"></i>
                      </div>
                      <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2 text-white/60"
                      >
                        <i class="fas fa-chevron-down text-xs"></i>
                      </div>
                      <select
                        name="role"
                        class="appearance-none bg-white/10 text-white text-xs rounded-lg pl-7 pr-6 h-9 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 w-full cursor-pointer"
                      >
                        <option
                          value=""
                          th:selected="${userRole == null || userRole.isBlank()}"
                        >
                          Any
                        </option>
                        <option
                          value="ADMIN"
                          th:selected="${userRole == 'ADMIN'}"
                        >
                          Admin
                        </option>
                        <option
                          value="TEACHER"
                          th:selected="${userRole == 'TEACHER'}"
                        >
                          Teacher
                        </option>
                        <option
                          value="STUDENT"
                          th:selected="${userRole == 'STUDENT'}"
                        >
                          Student
                        </option>
                      </select>
                    </div>

                    <button
                      type="submit"
                      class="bg-white/15 hover:bg-white/20 text-white text-xs px-3 h-9 rounded-lg border border-white/10 transition w-full sm:w-auto inline-flex items-center justify-center gap-2 flex-shrink-0"
                    >
                      <i class="fas fa-magnifying-glass text-xs"></i>
                      <span>Search</span>
                    </button>

                    <a
                      th:href="@{/admin(section='users')}"
                      href="/admin?section=users"
                      class="bg-white/10 hover:bg-white/15 text-white text-xs px-3 h-9 rounded-lg border border-white/10 transition no-underline inline-flex items-center justify-center gap-2 w-full sm:w-auto flex-shrink-0"
                    >
                      <i class="fas fa-rotate-left text-xs"></i>
                      <span>Clear</span>
                    </a>
                  </div>
                </form>

                <div
                  class="text-white/70 text-sm"
                  th:text="${adminUsers != null ? (adminUsers.size() + ' users') : '0 users'}"
                >
                  0 users
                </div>

                <div th:if="${adminUsers == null || adminUsers.isEmpty()}">
                  <p class="text-white/70 text-sm">No users found.</p>
                </div>

                <div
                  th:if="${adminUsers != null && !adminUsers.isEmpty()}"
                  class="mt-2 w-full min-w-0 overflow-x-auto rounded-xl border border-white/10"
                >
                  <table class="min-w-max text-left text-sm">
                    <thead class="bg-white/10 text-white/80">
                      <tr>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          User ID
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Name
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Email
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Roles
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Class
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          School Year
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Active
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Email Verified
                        </th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-white/10 text-white/80">
                      <tr th:each="u : ${adminUsers}" class="hover:bg-white/5">
                        <td
                          class="px-4 py-3 font-medium text-white whitespace-nowrap"
                          th:text="${u.userId}"
                        >
                          user
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <span
                            th:text="${(u.firstName ?: '') + (u.lastName != null ? (' ' + u.lastName) : '')}"
                          >
                            Name
                          </span>
                        </td>
                        <td
                          class="px-4 py-3 whitespace-nowrap"
                          th:text="${u.email ?: '-'}"
                        >
                          email
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <span
                            class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold border"
                            th:classappend="${u.roleKey == 'ADMIN'} ? ' bg-rose-500/20 text-rose-200 border-rose-500/30' : (${u.roleKey == 'TEACHER'} ? ' bg-sky-500/20 text-sky-200 border-sky-500/30' : ' bg-emerald-500/20 text-emerald-200 border-emerald-500/30')"
                            th:text="${u.roleKey != null && !u.roleKey.isBlank() ? u.roleKey : 'STUDENT'}"
                          >
                            STUDENT
                          </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <span
                            th:if="${u.roleKey == 'ADMIN' || u.roleKey == 'TEACHER'}"
                            >-</span
                          >
                          <form
                            th:if="${u.roleKey != 'ADMIN' and u.roleKey != 'TEACHER'}"
                            method="post"
                            action="/admin/users/student-meta"
                            th:action="@{/admin/users/student-meta}"
                            data-async="true"
                            class="inline-flex items-center"
                          >
                            <input
                              type="hidden"
                              th:name="${_csrf.parameterName}"
                              th:value="${_csrf.token}"
                            />
                            <input
                              type="hidden"
                              name="userId"
                              th:value="${u.userId}"
                            />
                            <input type="hidden" name="q" th:value="${userQ}" />
                            <input
                              type="hidden"
                              name="field"
                              th:value="${userField}"
                            />
                            <input
                              type="hidden"
                              name="roleFilter"
                              th:value="${userRole}"
                            />
                            <div class="relative">
                              <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2 text-white/60"
                              >
                                <i class="fas fa-chevron-down text-xs"></i>
                              </div>
                              <select
                                name="currentClass"
                                onchange="submitAsyncForm(this.form)"
                                class="appearance-none bg-white/10 text-white text-xs rounded-lg pl-2 pr-7 h-9 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 cursor-pointer w-[90px]"
                              >
                                <option
                                  value=""
                                  th:selected="${u.currentClass == null || u.currentClass.isBlank()}"
                                >
                                  -
                                </option>
                                <option
                                  value="A"
                                  th:selected="${u.currentClass == 'A'}"
                                >
                                  A
                                </option>
                                <option
                                  value="B"
                                  th:selected="${u.currentClass == 'B'}"
                                >
                                  B
                                </option>
                                <option
                                  value="C"
                                  th:selected="${u.currentClass == 'C'}"
                                >
                                  C
                                </option>
                                <option
                                  value="D"
                                  th:selected="${u.currentClass == 'D'}"
                                >
                                  D
                                </option>
                                <option
                                  value="E"
                                  th:selected="${u.currentClass == 'E'}"
                                >
                                  E
                                </option>
                                <option
                                  value="F"
                                  th:selected="${u.currentClass == 'F'}"
                                >
                                  F
                                </option>
                                <option
                                  value="G"
                                  th:selected="${u.currentClass == 'G'}"
                                >
                                  G
                                </option>
                                <option
                                  value="H"
                                  th:selected="${u.currentClass == 'H'}"
                                >
                                  H
                                </option>
                                <option
                                  value="I"
                                  th:selected="${u.currentClass == 'I'}"
                                >
                                  I
                                </option>
                                <option
                                  value="J"
                                  th:selected="${u.currentClass == 'J'}"
                                >
                                  J
                                </option>
                                <option
                                  value="K"
                                  th:selected="${u.currentClass == 'K'}"
                                >
                                  K
                                </option>
                                <option
                                  value="L"
                                  th:selected="${u.currentClass == 'L'}"
                                >
                                  L
                                </option>
                                <option
                                  value="M"
                                  th:selected="${u.currentClass == 'M'}"
                                >
                                  M
                                </option>
                                <option
                                  value="N"
                                  th:selected="${u.currentClass == 'N'}"
                                >
                                  N
                                </option>
                                <option
                                  value="O"
                                  th:selected="${u.currentClass == 'O'}"
                                >
                                  O
                                </option>
                                <option
                                  value="P"
                                  th:selected="${u.currentClass == 'P'}"
                                >
                                  P
                                </option>
                                <option
                                  value="Q"
                                  th:selected="${u.currentClass == 'Q'}"
                                >
                                  Q
                                </option>
                                <option
                                  value="R"
                                  th:selected="${u.currentClass == 'R'}"
                                >
                                  R
                                </option>
                                <option
                                  value="S"
                                  th:selected="${u.currentClass == 'S'}"
                                >
                                  S
                                </option>
                                <option
                                  value="T"
                                  th:selected="${u.currentClass == 'T'}"
                                >
                                  T
                                </option>
                                <option
                                  value="U"
                                  th:selected="${u.currentClass == 'U'}"
                                >
                                  U
                                </option>
                                <option
                                  value="V"
                                  th:selected="${u.currentClass == 'V'}"
                                >
                                  V
                                </option>
                                <option
                                  value="W"
                                  th:selected="${u.currentClass == 'W'}"
                                >
                                  W
                                </option>
                                <option
                                  value="X"
                                  th:selected="${u.currentClass == 'X'}"
                                >
                                  X
                                </option>
                                <option
                                  value="Y"
                                  th:selected="${u.currentClass == 'Y'}"
                                >
                                  Y
                                </option>
                                <option
                                  value="Z"
                                  th:selected="${u.currentClass == 'Z'}"
                                >
                                  Z
                                </option>
                              </select>
                            </div>
                          </form>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <span
                            th:if="${u.roleKey == 'ADMIN' || u.roleKey == 'TEACHER'}"
                            >-</span
                          >
                          <form
                            th:if="${u.roleKey != 'ADMIN' and u.roleKey != 'TEACHER'}"
                            method="post"
                            action="/admin/users/student-meta"
                            th:action="@{/admin/users/student-meta}"
                            data-async="true"
                            class="inline-flex items-center"
                          >
                            <input
                              type="hidden"
                              th:name="${_csrf.parameterName}"
                              th:value="${_csrf.token}"
                            />
                            <input
                              type="hidden"
                              name="userId"
                              th:value="${u.userId}"
                            />
                            <input type="hidden" name="q" th:value="${userQ}" />
                            <input
                              type="hidden"
                              name="field"
                              th:value="${userField}"
                            />
                            <input
                              type="hidden"
                              name="roleFilter"
                              th:value="${userRole}"
                            />
                            <div class="relative">
                              <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2 text-white/60"
                              >
                                <i class="fas fa-chevron-down text-xs"></i>
                              </div>
                              <select
                                name="schoolYear"
                                onchange="submitAsyncForm(this.form)"
                                class="appearance-none bg-white/10 text-white text-xs rounded-lg pl-3 pr-7 h-9 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 cursor-pointer w-[112px]"
                              >
                                <option
                                  value=""
                                  th:selected="${u.schoolYear == null || u.schoolYear.isBlank()}"
                                >
                                  -
                                </option>
                                <option
                                  value="1"
                                  th:selected="${u.schoolYear == '1'}"
                                >
                                  1
                                </option>
                                <option
                                  value="2"
                                  th:selected="${u.schoolYear == '2'}"
                                >
                                  2
                                </option>
                                <option
                                  value="3"
                                  th:selected="${u.schoolYear == '3'}"
                                >
                                  3
                                </option>
                                <option
                                  value="4"
                                  th:selected="${u.schoolYear == '4'}"
                                >
                                  4
                                </option>
                                <option
                                  value="5"
                                  th:selected="${u.schoolYear == '5'}"
                                >
                                  5
                                </option>
                                <option
                                  value="6"
                                  th:selected="${u.schoolYear == '6'}"
                                >
                                  6
                                </option>
                                <option
                                  value="7"
                                  th:selected="${u.schoolYear == '7'}"
                                >
                                  7
                                </option>
                                <option
                                  value="8"
                                  th:selected="${u.schoolYear == '8'}"
                                >
                                  8
                                </option>
                                <option
                                  value="9"
                                  th:selected="${u.schoolYear == '9'}"
                                >
                                  9
                                </option>
                                <option
                                  value="10"
                                  th:selected="${u.schoolYear == '10'}"
                                >
                                  10
                                </option>
                              </select>
                            </div>
                          </form>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <div class="flex items-center gap-3">
                            <span
                              class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold"
                              th:classappend="${u.active != null && u.active} ? ' bg-emerald-500/20 text-emerald-200' : ' bg-rose-500/20 text-rose-200'"
                              th:text="${u.active != null && u.active} ? 'Active' : 'Inactive'"
                            >
                              Active
                            </span>

                            <form
                              method="post"
                              action="/admin/users/active"
                              th:action="@{/admin/users/active}"
                              th:if="${u.roleKey != 'ADMIN'}"
                              data-async="true"
                              class="flex items-center"
                            >
                              <input
                                type="hidden"
                                th:name="${_csrf.parameterName}"
                                th:value="${_csrf.token}"
                              />
                              <input
                                type="hidden"
                                name="userId"
                                th:value="${u.userId}"
                              />
                              <input
                                type="hidden"
                                name="active"
                                th:value="${u.active != null && u.active} ? 'true' : 'false'"
                              />
                              <input
                                type="hidden"
                                name="q"
                                th:value="${userQ}"
                              />
                              <input
                                type="hidden"
                                name="field"
                                th:value="${userField}"
                              />
                              <input
                                type="hidden"
                                name="roleFilter"
                                th:value="${userRole}"
                              />
                              <label
                                class="relative inline-flex cursor-pointer items-center"
                              >
                                <input
                                  type="checkbox"
                                  class="sr-only peer"
                                  th:checked="${u.active != null && u.active}"
                                  onchange="
                                    var h = this.form.querySelector(
                                      'input[type=hidden][name=active]',
                                    );
                                    if (h) {
                                      h.value = this.checked ? 'true' : 'false';
                                    }
                                    var badge = this.form.parentElement
                                      ? this.form.parentElement.querySelector(
                                          'span',
                                        )
                                      : null;
                                    if (badge) {
                                      badge.textContent = this.checked
                                        ? 'Active'
                                        : 'Inactive';
                                      badge.classList.remove(
                                        'bg-emerald-500/20',
                                        'text-emerald-200',
                                        'bg-rose-500/20',
                                        'text-rose-200',
                                      );
                                      badge.classList.add(
                                        this.checked
                                          ? 'bg-emerald-500/20'
                                          : 'bg-rose-500/20',
                                      );
                                      badge.classList.add(
                                        this.checked
                                          ? 'text-emerald-200'
                                          : 'text-rose-200',
                                      );
                                    }
                                    submitAsyncForm(this.form);
                                  "
                                />
                                <div
                                  class="relative h-5 w-10 rounded-full border border-white/10 bg-white/10 transition peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-white/20 peer-checked:border-emerald-500/40 peer-checked:bg-emerald-500/30 after:absolute after:left-0.5 after:top-0.5 after:h-4 after:w-4 after:rounded-full after:bg-white/70 after:transition-all peer-checked:after:translate-x-5"
                                ></div>
                              </label>
                            </form>
                          </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <span
                            class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold"
                            th:classappend="${u.emailVerified != null && u.emailVerified} ? ' bg-emerald-500/20 text-emerald-200' : ' bg-amber-500/20 text-amber-200'"
                            th:text="${u.emailVerified != null && u.emailVerified} ? 'Verified' : 'Unverified'"
                          >
                            Verified
                          </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <div
                            class="flex items-center gap-2 flex-nowrap overflow-x-auto"
                          >
                            <form
                              method="post"
                              action="/admin/users/role"
                              th:action="@{/admin/users/role}"
                              th:if="${currentUserId == null || u.userId != currentUserId}"
                              onsubmit="return confirmAdminAssign(this);"
                              class="flex items-center gap-2 flex-nowrap flex-shrink-0"
                            >
                              <input
                                type="hidden"
                                th:name="${_csrf.parameterName}"
                                th:value="${_csrf.token}"
                              />
                              <input
                                type="hidden"
                                name="userId"
                                th:value="${u.userId}"
                              />
                              <input
                                type="hidden"
                                name="q"
                                th:value="${userQ}"
                              />
                              <input
                                type="hidden"
                                name="field"
                                th:value="${userField}"
                              />
                              <input
                                type="hidden"
                                name="roleFilter"
                                th:value="${userRole}"
                              />
                              <div class="relative">
                                <div
                                  class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2 text-white/60"
                                >
                                  <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                                <select
                                  name="role"
                                  class="appearance-none bg-white/10 text-white text-xs rounded-lg pl-2 pr-7 h-9 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 cursor-pointer"
                                >
                                  <option
                                    value="ADMIN"
                                    th:selected="${u.roleKey == 'ADMIN'}"
                                  >
                                    Admin
                                  </option>
                                  <option
                                    value="TEACHER"
                                    th:selected="${u.roleKey == 'TEACHER'}"
                                  >
                                    Teacher
                                  </option>
                                  <option
                                    value="STUDENT"
                                    th:selected="${u.roleKey == 'STUDENT' || u.roleKey == null || u.roleKey.isBlank()}"
                                  >
                                    Student
                                  </option>
                                </select>
                              </div>
                              <button
                                type="submit"
                                class="bg-white/15 hover:bg-white/20 text-white text-xs px-3 h-9 rounded-lg border border-white/10 transition inline-flex items-center justify-center gap-2 flex-shrink-0"
                              >
                                Update
                              </button>
                            </form>

                            <form
                              method="post"
                              action="/admin/users/delete"
                              th:action="@{/admin/users/delete}"
                              th:if="${currentUserId == null || u.userId != currentUserId}"
                              onsubmit="return confirm('Delete this user?');"
                              class="flex-shrink-0"
                            >
                              <input
                                type="hidden"
                                th:name="${_csrf.parameterName}"
                                th:value="${_csrf.token}"
                              />
                              <input
                                type="hidden"
                                name="userId"
                                th:value="${u.userId}"
                              />
                              <input
                                type="hidden"
                                name="q"
                                th:value="${userQ}"
                              />
                              <input
                                type="hidden"
                                name="field"
                                th:value="${userField}"
                              />
                              <input
                                type="hidden"
                                name="roleFilter"
                                th:value="${userRole}"
                              />
                              <button
                                type="submit"
                                class="bg-rose-500/20 hover:bg-rose-500/30 text-rose-200 text-xs px-3 h-9 rounded-lg border border-rose-500/30 transition inline-flex items-center justify-center flex-shrink-0"
                              >
                                Delete
                              </button>
                            </form>
                            <span
                              th:if="${currentUserId != null && u.userId == currentUserId}"
                              class="inline-flex items-center text-white/50 text-xs h-9 flex-shrink-0"
                              >-</span
                            >
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div th:if="${section == 'settings'}" class="space-y-2">
                <h2 class="text-white text-2xl font-bold">
                  <span th:text="#{adminPanel.settings}">Settings</span>
                </h2>

                <form
                  th:if="${isAdmin}"
                  th:action="@{/admin/settings/registration-domain}"
                  method="post"
                  class="mt-4 max-w-xl space-y-4"
                >
                  <input
                    type="hidden"
                    th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}"
                  />

                  <div
                    class="rounded-2xl border border-white/15 bg-white/5 p-4 space-y-3"
                  >
                    <div class="flex items-center justify-between gap-3">
                      <div class="min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="text-white font-semibold text-sm">
                            Limit registration by email domain
                          </span>
                          <span
                            class="inline-flex items-center rounded-full bg-white/10 px-2 py-0.5 text-[11px] font-medium text-white/70"
                          >
                            Admin only
                          </span>
                        </div>
                        <p class="text-white/70 text-xs mt-1">
                          When enabled, only email addresses ending with the
                          specified domain can register.
                        </p>
                      </div>

                      <label
                        class="relative inline-flex cursor-pointer items-center flex-shrink-0"
                      >
                        <input
                          type="checkbox"
                          name="enforceDomain"
                          class="sr-only peer"
                          th:checked="${registrationDomainEnforced}"
                        />
                        <div
                          class="relative h-5 w-10 rounded-full border border-white/10 bg-white/10 transition peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-white/20 peer-checked:border-emerald-500/40 peer-checked:bg-emerald-500/30 after:absolute after:left-0.5 after:top-0.5 after:h-4 after:w-4 after:rounded-full after:bg-white/70 after:transition-all peer-checked:after:translate-x-5"
                        ></div>
                      </label>
                    </div>

                    <div class="space-y-1">
                      <label
                        for="allowedDomain"
                        class="block text-xs font-medium text-white/80"
                      >
                        Allowed email domain
                      </label>
                      <div class="flex flex-col sm:flex-row gap-2">
                        <div class="relative flex-1 min-w-0">
                          <div
                            class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-white/60 text-xs"
                          >
                            @
                          </div>
                          <input
                            id="allowedDomain"
                            name="allowedDomain"
                            type="text"
                            inputmode="email"
                            autocomplete="off"
                            placeholder="school.edu"
                            th:value="${registrationDomainDisplay}"
                            class="bg-white/10 text-white text-sm rounded-lg pl-7 pr-3 h-9 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40"
                          />
                        </div>
                      </div>
                      <p class="text-[11px] text-white/60">
                        Enter a domain like
                        <span class="font-mono">school.edu</span>. Users will
                        only be able to register with emails ending in this
                        domain when the toggle is on.
                      </p>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <button
                      type="submit"
                      class="inline-flex items-center justify-center gap-2 rounded-lg border border-emerald-500/40 bg-emerald-500/25 px-4 h-9 text-sm font-medium text-emerald-50 hover:bg-emerald-500/35 transition"
                    >
                      <i class="fas fa-save text-xs"></i>
                      <span>Save settings</span>
                    </button>

                    <div
                      th:if="${registrationDomainEnforced}"
                      class="inline-flex items-center gap-2 rounded-full border border-amber-400/40 bg-amber-500/10 px-3 h-8 text-[11px] font-medium text-amber-100"
                    >
                      <i class="fas fa-circle-info text-xs"></i>
                      <span
                        >Registration limited to @<span
                          class="font-mono"
                          th:text="${registrationDomainDisplay}"
                          >domain.com</span
                        ></span
                      >
                    </div>
                  </div>
                </form>

                <div
                  th:if="${!isAdmin}"
                  class="mt-4 max-w-xl rounded-2xl border border-white/15 bg-white/5 p-4 text-sm text-white/75"
                >
                  <div class="font-semibold text-white">
                    Registration email domain
                  </div>
                  <p class="mt-1 text-xs text-white/70">
                    Only Admin users can change registration domain settings.
                    Please contact an Admin if you need to update this policy.
                  </p>
                </div>
              </div>

              <div
                th:if="${section == 'courses' or (section == 'users' and !isAdmin) or (section != 'users' and section != 'courses' and section != 'settings')}"
                class="space-y-4"
              >
                <div
                  id="coursesManagementRoot"
                  class="space-y-4"
                  data-storage-key="adminCoursesDraft_v1"
                >
                  <div
                    class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3"
                  >
                    <div class="min-w-0">
                      <h2 class="text-white text-2xl font-bold">
                        <span th:text="#{adminPanel.courses}"
                          >Courses Management</span
                        >
                      </h2>
                      <p class="text-white/70 text-sm mt-1">
                        UI-only for now. Database connection will be added
                        later.
                      </p>
                    </div>
                    <button
                      id="addCourseBtn"
                      type="button"
                      class="inline-flex items-center justify-center gap-2 rounded-lg border border-white/15 bg-white/10 px-4 h-10 text-sm font-semibold text-white hover:bg-white/15 transition flex-shrink-0"
                    >
                      <i class="fas fa-plus text-xs"></i>
                      <span>Add course</span>
                    </button>
                  </div>

                  <div
                    class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl overflow-hidden"
                  >
                    <div
                      class="flex flex-col lg:flex-row divide-y lg:divide-y-0 lg:divide-x divide-white/10 lg:py-4"
                    >
                      <div class="p-4 lg:py-0 lg:w-4/12">
                        <div class="flex items-center justify-between gap-3">
                          <div class="text-white font-semibold">Courses</div>
                          <div
                            id="courseCountBadge"
                            class="inline-flex items-center rounded-full border border-white/15 bg-white/10 px-2.5 h-7 text-[11px] font-semibold text-white/90"
                          >
                            0
                          </div>
                        </div>

                        <div
                          id="courseListEmpty"
                          class="mt-3 rounded-xl border border-white/10 bg-white/5 px-4 py-4 text-sm text-white/70"
                        >
                          No courses yet. Create one to start adding chapters
                          and subchapters.
                        </div>
                        <div id="courseList" class="mt-3 space-y-2"></div>
                      </div>

                      <div class="p-4 lg:py-0 min-w-0 flex-1 min-h-[260px]">
                        <div
                          id="courseDetailsEmpty"
                          class="rounded-xl border border-white/10 bg-white/5 px-4 py-5 text-sm text-white/70"
                        >
                          Select a course to manage chapters and subchapters.
                        </div>

                        <div id="courseDetails" class="hidden space-y-4">
                          <div
                            class="flex flex-col sm:flex-row sm:items-stretch gap-4"
                          >
                            <div class="flex-shrink-0">
                              <img
                                id="selectedCourseCover"
                                alt="Course cover"
                                class="hidden aspect-[2/3] w-36 rounded-xl border border-white/10 object-cover bg-white/5"
                              />
                            </div>

                            <div class="min-w-0 flex-1 flex flex-col gap-4">
                              <div
                                id="selectedCourseTitle"
                                class="text-white text-xl font-bold leading-tight break-words"
                              ></div>
                              <div
                                id="selectedCourseDescription"
                                class="text-white/75 text-sm leading-relaxed"
                              ></div>
                              <div class="flex items-center gap-2 flex-wrap">
                                <div
                                  id="selectedCourseLanguage"
                                  class="hidden inline-flex items-center gap-2 rounded-full border border-sky-500/30 bg-sky-500/10 px-2.5 h-7 text-[11px] font-semibold text-sky-100"
                                ></div>
                                <div
                                  id="selectedCourseTargets"
                                  class="flex items-center gap-2 flex-wrap"
                                ></div>
                              </div>
                            </div>
                          </div>

                          <div class="pt-4 border-t border-white/10">
                            <div
                              class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
                            >
                              <div class="text-white font-semibold">
                                Chapters
                              </div>
                              <div
                                class="flex items-center justify-end gap-2 flex-wrap"
                              >
                                <button
                                  id="editCourseBtn"
                                  type="button"
                                  class="inline-flex items-center justify-center gap-2 rounded-lg border border-white/15 bg-white/10 px-3 h-10 text-sm font-semibold text-white hover:bg-white/15 transition"
                                >
                                  <i class="fas fa-pen text-xs"></i>
                                  <span class="hidden sm:inline">Edit</span>
                                </button>
                                <button
                                  id="deleteCourseBtn"
                                  type="button"
                                  class="inline-flex items-center justify-center gap-2 rounded-lg border border-rose-500/40 bg-rose-500/15 px-3 h-10 text-sm font-semibold text-rose-50 hover:bg-rose-500/25 transition"
                                >
                                  <i class="fas fa-trash text-xs"></i>
                                  <span class="hidden sm:inline">Delete</span>
                                </button>
                                <button
                                  id="addChapterBtn"
                                  type="button"
                                  class="inline-flex items-center justify-center gap-2 rounded-lg border border-emerald-500/40 bg-emerald-500/20 px-4 h-10 text-sm font-semibold text-emerald-50 hover:bg-emerald-500/30 transition"
                                >
                                  <i class="fas fa-layer-group text-xs"></i>
                                  <span>Add chapter</span>
                                </button>
                                <div
                                  id="chapterCountBadge"
                                  class="inline-flex items-center rounded-full border border-white/15 bg-white/10 px-2.5 h-7 text-[11px] font-semibold text-white/90"
                                >
                                  0
                                </div>
                              </div>
                            </div>

                            <div
                              id="chapterListEmpty"
                              class="mt-3 rounded-xl border border-white/10 px-4 py-4 text-sm text-white/70"
                            >
                              No chapters yet. Add a chapter to start creating
                              subchapters.
                            </div>
                            <div id="chapterList" class="mt-3 space-y-3"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div
      id="assignAdminModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70"
      role="dialog"
      aria-modal="true"
      aria-labelledby="assignAdminTitle"
    >
      <div
        class="w-full max-w-lg rounded-2xl border border-rose-500/30 bg-slate-950/90 backdrop-blur-xl shadow-2xl"
      >
        <div class="p-5 sm:p-6">
          <div class="flex items-start gap-3">
            <div
              class="w-10 h-10 rounded-xl bg-rose-500/20 border border-rose-500/30 flex items-center justify-center flex-shrink-0"
            >
              <i class="fas fa-triangle-exclamation text-rose-200"></i>
            </div>
            <div class="min-w-0">
              <h3
                id="assignAdminTitle"
                class="text-white text-lg sm:text-xl font-bold"
              >
                Assign Admin role?
              </h3>
              <p class="text-white/80 text-sm mt-2">
                You are about to assign the Admin role to
                <span
                  id="assignAdminTargetUserId"
                  class="font-semibold text-white"
                ></span
                >.
              </p>
              <div
                class="mt-4 rounded-xl border border-amber-500/30 bg-amber-500/10 p-4"
              >
                <div class="text-amber-200 font-semibold text-sm">
                  Your role will be changed to Teacher and you will be logged
                  out.
                </div>
                <div class="text-white/75 text-sm mt-1">
                  This is required to ensure there is always at least one Admin.
                </div>
              </div>
            </div>
          </div>
          <div class="mt-5 flex flex-col sm:flex-row gap-2 sm:justify-end">
            <button
              id="assignAdminCancel"
              type="button"
              class="bg-white/10 hover:bg-white/15 text-white text-sm px-4 h-10 rounded-lg border border-white/10 transition inline-flex items-center justify-center"
            >
              Cancel
            </button>
            <button
              id="assignAdminConfirm"
              type="button"
              class="bg-rose-500/30 hover:bg-rose-500/40 text-rose-100 text-sm px-4 h-10 rounded-lg border border-rose-500/40 transition inline-flex items-center justify-center"
            >
              Assign Admin &amp; Log out
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="addCourseModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addCourseTitle"
    >
      <div
        class="w-full max-w-xl rounded-2xl border border-white/15 bg-slate-950/90 backdrop-blur-xl shadow-2xl"
      >
        <form id="addCourseForm" class="p-5 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <h3 id="addCourseTitle" class="text-white text-lg font-bold">
                Add course
              </h3>
              <p class="text-white/75 text-sm mt-1">
                Title, description, and an optional cover image.
              </p>
            </div>
            <button
              id="addCourseClose"
              type="button"
              class="h-10 w-10 rounded-lg border border-white/10 bg-white/5 text-white/80 hover:bg-white/10 hover:text-white transition inline-flex items-center justify-center flex-shrink-0"
              aria-label="Close"
            >
              <i class="fas fa-xmark"></i>
            </button>
          </div>

          <div id="addCourseError" class="hidden"></div>

          <div class="space-y-2">
            <label
              class="block text-xs font-medium text-white/80"
              for="courseTitle"
              >Course title</label
            >
            <input
              id="courseTitle"
              name="courseTitle"
              type="text"
              required
              maxlength="120"
              placeholder="Japanese Netiquette"
              class="bg-white/10 text-white text-sm rounded-lg px-3 h-10 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40"
            />
          </div>

          <div class="space-y-2">
            <label
              class="block text-xs font-medium text-white/80"
              for="courseLanguage"
              >Course language</label
            >
            <select
              id="courseLanguage"
              name="courseLanguage"
              class="bg-white/10 text-white text-sm rounded-lg px-3 h-10 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full"
            >
              <option value="">Select language</option>
              <option value="en">English</option>
              <option value="my">Myanmar (Burmese)</option>
              <option value="zh">Chinese</option>
              <option value="ne">Nepali</option>
              <option value="vi">Vietnamese</option>
              <option value="uz">Uzbek</option>
              <option value="si">Sinhala</option>
              <option value="hi">Hindi</option>
              <option value="ja">Japanese</option>
              <option value="bd">Bangla</option>
            </select>
          </div>

          <div class="space-y-2">
            <label class="block text-xs font-medium text-white/80"
              >Target students</label
            >
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                <div class="text-white/70 text-xs font-semibold">
                  School years
                </div>
                <div
                  id="targetSchoolYearsOptions"
                  class="mt-2 flex flex-wrap gap-2"
                ></div>
              </div>
              <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                <div class="text-white/70 text-xs font-semibold">Classes</div>
                <div
                  id="targetClassesOptions"
                  class="mt-2 flex flex-wrap gap-2 max-h-32 overflow-auto pr-1"
                ></div>
              </div>
            </div>
            <div class="text-[11px] text-white/60">
              Leave empty to make the course visible to all students (UI only).
            </div>
          </div>

          <div class="space-y-2">
            <label
              class="block text-xs font-medium text-white/80"
              for="courseDescription"
              >Description</label
            >
            <textarea
              id="courseDescription"
              name="courseDescription"
              rows="4"
              maxlength="800"
              placeholder="What this course is about"
              class="bg-white/10 text-white text-sm rounded-lg px-3 py-2 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40 resize-none"
            ></textarea>
          </div>

          <div class="space-y-2">
            <label
              class="block text-xs font-medium text-white/80"
              for="courseCover"
              >Cover image</label
            >
            <div class="flex items-start gap-4">
              <img
                id="courseCoverPreview"
                alt="Cover preview"
                class="hidden h-20 w-28 rounded-xl border border-white/10 object-cover bg-white/5 flex-shrink-0"
              />
              <div class="min-w-0 flex-1 space-y-2">
                <input
                  id="courseCover"
                  name="courseCover"
                  type="file"
                  accept="image/*"
                  class="block w-full text-sm text-white/80 file:mr-3 file:rounded-lg file:border file:border-white/15 file:bg-white/10 file:px-3 file:h-10 file:text-white file:text-sm file:font-semibold hover:file:bg-white/15 file:transition"
                />
                <button
                  id="removeCourseCoverBtn"
                  type="button"
                  class="hidden inline-flex items-center justify-center gap-2 rounded-lg border border-white/15 bg-white/5 px-3 h-9 text-xs font-semibold text-white/90 hover:bg-white/10 transition"
                >
                  <i class="fas fa-image text-[10px]"></i>
                  <span>Remove cover</span>
                </button>
                <div class="text-[11px] text-white/60">
                  Images are stored locally in your browser for now.
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 sm:justify-end pt-1">
            <button
              id="addCourseCancel"
              type="button"
              class="bg-white/10 hover:bg-white/15 text-white text-sm px-4 h-10 rounded-lg border border-white/10 transition inline-flex items-center justify-center"
            >
              Cancel
            </button>
            <button
              id="addCourseSubmit"
              type="submit"
              class="bg-white/20 hover:bg-white/25 text-white text-sm px-4 h-10 rounded-lg border border-white/15 transition inline-flex items-center justify-center font-semibold"
            >
              Create course
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="addChapterModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addChapterTitle"
    >
      <div
        class="w-full max-w-lg rounded-2xl border border-white/15 bg-slate-950/90 backdrop-blur-xl shadow-2xl"
      >
        <form id="addChapterForm" class="p-5 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <h3 id="addChapterTitle" class="text-white text-lg font-bold">
                Add chapter
              </h3>
              <div class="text-white/75 text-sm mt-1">
                Course:
                <span
                  id="addChapterCourseTitle"
                  class="font-semibold text-white"
                  >-</span
                >
              </div>
            </div>
            <button
              id="addChapterClose"
              type="button"
              class="h-10 w-10 rounded-lg border border-white/10 bg-white/5 text-white/80 hover:bg-white/10 hover:text-white transition inline-flex items-center justify-center flex-shrink-0"
              aria-label="Close"
            >
              <i class="fas fa-xmark"></i>
            </button>
          </div>

          <div id="addChapterError" class="hidden"></div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="space-y-2 sm:col-span-1">
              <label
                class="block text-xs font-medium text-white/80"
                for="chapterNumber"
                >Chapter #</label
              >
              <input
                id="chapterNumber"
                name="chapterNumber"
                type="number"
                required
                min="1"
                step="1"
                placeholder="1"
                class="bg-white/10 text-white text-sm rounded-lg px-3 h-10 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40"
              />
            </div>
            <div class="space-y-2 sm:col-span-2">
              <label
                class="block text-xs font-medium text-white/80"
                for="chapterName"
                >Chapter name</label
              >
              <input
                id="chapterName"
                name="chapterName"
                type="text"
                required
                maxlength="160"
                placeholder="Introduction"
                class="bg-white/10 text-white text-sm rounded-lg px-3 h-10 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40"
              />
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 sm:justify-end pt-1">
            <button
              id="addChapterCancel"
              type="button"
              class="bg-white/10 hover:bg-white/15 text-white text-sm px-4 h-10 rounded-lg border border-white/10 transition inline-flex items-center justify-center"
            >
              Cancel
            </button>
            <button
              id="addChapterSubmit"
              type="submit"
              class="bg-emerald-500/25 hover:bg-emerald-500/35 text-emerald-50 text-sm px-4 h-10 rounded-lg border border-emerald-500/40 transition inline-flex items-center justify-center font-semibold"
            >
              Create chapter
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="addSubchapterModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addSubchapterTitle"
    >
      <div
        class="w-full max-w-lg rounded-2xl border border-white/15 bg-slate-950/90 backdrop-blur-xl shadow-2xl"
      >
        <form id="addSubchapterForm" class="p-5 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <h3 id="addSubchapterTitle" class="text-white text-lg font-bold">
                Add subchapter
              </h3>
              <div class="text-white/75 text-sm mt-1">
                Chapter:
                <span
                  id="addSubchapterChapterTitle"
                  class="font-semibold text-white"
                  >-</span
                >
              </div>
            </div>
            <button
              id="addSubchapterClose"
              type="button"
              class="h-10 w-10 rounded-lg border border-white/10 bg-white/5 text-white/80 hover:bg-white/10 hover:text-white transition inline-flex items-center justify-center flex-shrink-0"
              aria-label="Close"
            >
              <i class="fas fa-xmark"></i>
            </button>
          </div>

          <div id="addSubchapterError" class="hidden"></div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="space-y-2 sm:col-span-1">
              <label
                class="block text-xs font-medium text-white/80"
                for="subchapterOrder"
                >Order</label
              >
              <input
                id="subchapterOrder"
                name="subchapterOrder"
                type="number"
                required
                min="1"
                step="1"
                placeholder="1"
                class="bg-white/10 text-white text-sm rounded-lg px-3 h-10 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40"
              />
            </div>
            <div class="space-y-2 sm:col-span-2">
              <label
                class="block text-xs font-medium text-white/80"
                for="subchapterTitle"
                >Subchapter title</label
              >
              <input
                id="subchapterTitle"
                name="subchapterTitle"
                type="text"
                required
                maxlength="200"
                placeholder="Lesson 1"
                class="bg-white/10 text-white text-sm rounded-lg px-3 h-10 border border-white/15 focus:outline-none focus:ring-2 focus:ring-white/25 w-full placeholder:text-white/40"
              />
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 sm:justify-end pt-1">
            <button
              id="addSubchapterCancel"
              type="button"
              class="bg-white/10 hover:bg-white/15 text-white text-sm px-4 h-10 rounded-lg border border-white/10 transition inline-flex items-center justify-center"
            >
              Cancel
            </button>
            <button
              id="addSubchapterSubmit"
              type="submit"
              class="bg-white/20 hover:bg-white/25 text-white text-sm px-4 h-10 rounded-lg border border-white/15 transition inline-flex items-center justify-center font-semibold"
            >
              Create subchapter
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="/js/navbar.js"></script>
    <script>
      (function () {
        var modal = document.getElementById("assignAdminModal");
        var targetEl = document.getElementById("assignAdminTargetUserId");
        var cancelBtn = document.getElementById("assignAdminCancel");
        var confirmBtn = document.getElementById("assignAdminConfirm");
        if (!modal || !targetEl || !cancelBtn || !confirmBtn) return;

        var pendingForm = null;

        function closeModal() {
          modal.classList.add("hidden");
          pendingForm = null;
          targetEl.textContent = "";
        }

        cancelBtn.addEventListener("click", function () {
          closeModal();
        });

        modal.addEventListener("click", function (e) {
          if (e.target === modal) closeModal();
        });

        confirmBtn.addEventListener("click", function () {
          if (pendingForm) pendingForm.submit();
        });

        window.confirmAdminAssign = function (form) {
          try {
            var select = form.querySelector('select[name="role"]');
            if (!select || select.value !== "ADMIN") return true;

            var userIdInput = form.querySelector('input[name="userId"]');
            targetEl.textContent = userIdInput
              ? userIdInput.value
              : "this user";
            pendingForm = form;
            modal.classList.remove("hidden");
            return false;
          } catch (e) {
            return true;
          }
        };
      })();
    </script>
    <div
      id="adminAsyncToast"
      class="fixed bottom-4 right-4 z-[60] hidden items-center gap-2 rounded-xl border border-white/15 bg-slate-950/90 px-4 py-3 text-sm text-white shadow-2xl backdrop-blur"
    >
      <span id="adminAsyncToastText">Saved</span>
    </div>
    <div
      id="confirmDeleteModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70"
      role="dialog"
      aria-modal="true"
      aria-labelledby="confirmDeleteTitle"
    >
      <div
        class="w-full max-w-lg rounded-2xl border border-rose-500/30 bg-slate-950/90 backdrop-blur-xl shadow-2xl"
      >
        <div class="p-5 sm:p-6">
          <div class="flex items-start gap-3">
            <div
              class="w-10 h-10 rounded-xl bg-rose-500/20 border border-rose-500/30 flex items-center justify-center flex-shrink-0"
            >
              <i class="fas fa-trash text-rose-200"></i>
            </div>
            <div class="min-w-0">
              <h3 id="confirmDeleteTitle" class="text-white text-lg font-bold">
                Delete
              </h3>
              <p id="confirmDeleteMessage" class="text-white/80 text-sm mt-2">
                Are you sure?
              </p>
            </div>
          </div>
          <div class="mt-5 flex flex-col sm:flex-row gap-2 sm:justify-end">
            <button
              id="confirmDeleteCancel"
              type="button"
              class="bg-white/10 hover:bg-white/15 text-white text-sm px-4 h-10 rounded-lg border border-white/10 transition inline-flex items-center justify-center"
            >
              Cancel
            </button>
            <button
              id="confirmDeleteConfirm"
              type="button"
              class="bg-rose-500/30 hover:bg-rose-500/40 text-rose-100 text-sm px-4 h-10 rounded-lg border border-rose-500/40 transition inline-flex items-center justify-center font-semibold"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        var toast = document.getElementById("adminAsyncToast");
        var toastText = document.getElementById("adminAsyncToastText");
        var toastTimer = null;

        function showToast(message, ok) {
          if (!toast || !toastText) return;
          toastText.textContent = message || (ok ? "Saved" : "Failed to save");
          toast.classList.remove("hidden");
          toast.classList.add("flex");
          toast.classList.toggle("border-emerald-500/30", !!ok);
          toast.classList.toggle("border-rose-500/30", !ok);
          if (toastTimer) clearTimeout(toastTimer);
          toastTimer = setTimeout(
            function () {
              toast.classList.add("hidden");
              toast.classList.remove("flex");
            },
            ok ? 1200 : 2500,
          );
        }

        window.submitAsyncForm = function (form) {
          try {
            if (!form) return;
            if (!form.hasAttribute("data-async")) {
              form.submit();
              return;
            }
            if (form.dataset.submitting === "true") return;
            form.dataset.submitting = "true";

            var action = form.getAttribute("action") || form.action;
            var method = (form.getAttribute("method") || "GET").toUpperCase();
            if (method !== "POST" || !action) {
              form.submit();
              return;
            }

            fetch(action, {
              method: "POST",
              body: new FormData(form),
              credentials: "same-origin",
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (res) {
                if (res && res.ok) {
                  showToast("Saved", true);
                } else {
                  showToast("Failed to save", false);
                }
              })
              .catch(function () {
                showToast("Failed to save", false);
              })
              .finally(function () {
                form.dataset.submitting = "false";
              });
          } catch (e) {
            try {
              form.submit();
            } catch (e2) {}
          }
        };
      })();
    </script>
    <script>
      (function () {
        var root = document.getElementById("coursesManagementRoot");
        if (!root) return;

        var storageKey = root.getAttribute("data-storage-key");
        var state = {
          courses: [],
          selectedCourseId: null,
          openChapterId: null,
        };

        function uid(prefix) {
          return (
            (prefix || "id") +
            "_" +
            Math.random().toString(16).slice(2) +
            "_" +
            Date.now().toString(16)
          );
        }

        function safeJsonParse(raw) {
          try {
            return JSON.parse(raw);
          } catch (e) {
            return null;
          }
        }

        function loadState() {
          try {
            if (!storageKey) return;
            var raw = localStorage.getItem(storageKey);
            if (!raw) return;
            var loaded = safeJsonParse(raw);
            if (!loaded || typeof loaded !== "object") return;
            if (!Array.isArray(loaded.courses)) return;
            state.courses = loaded.courses;
            state.selectedCourseId = loaded.selectedCourseId || null;
            state.openChapterId =
              typeof loaded.openChapterId === "string"
                ? loaded.openChapterId
                : null;
          } catch (e) {}
        }

        function saveState() {
          try {
            if (!storageKey) return;
            localStorage.setItem(storageKey, JSON.stringify(state));
          } catch (e) {}
        }

        var addCourseBtn = document.getElementById("addCourseBtn");
        var courseList = document.getElementById("courseList");
        var courseListEmpty = document.getElementById("courseListEmpty");
        var courseCountBadge = document.getElementById("courseCountBadge");

        var courseDetailsEmpty = document.getElementById("courseDetailsEmpty");
        var courseDetails = document.getElementById("courseDetails");
        var selectedCourseTitle = document.getElementById(
          "selectedCourseTitle",
        );
        var selectedCourseLanguage = document.getElementById(
          "selectedCourseLanguage",
        );
        var selectedCourseTargets = document.getElementById(
          "selectedCourseTargets",
        );
        var selectedCourseDescription = document.getElementById(
          "selectedCourseDescription",
        );
        var selectedCourseCover = document.getElementById(
          "selectedCourseCover",
        );
        var addChapterBtn = document.getElementById("addChapterBtn");
        var editCourseBtn = document.getElementById("editCourseBtn");
        var deleteCourseBtn = document.getElementById("deleteCourseBtn");
        var chapterList = document.getElementById("chapterList");
        var chapterListEmpty = document.getElementById("chapterListEmpty");
        var chapterCountBadge = document.getElementById("chapterCountBadge");

        var addCourseModal = document.getElementById("addCourseModal");
        var addCourseForm = document.getElementById("addCourseForm");
        var addCourseCancel = document.getElementById("addCourseCancel");
        var addCourseClose = document.getElementById("addCourseClose");
        var addCourseTitleEl = document.getElementById("addCourseTitle");
        var addCourseSubmitBtn = document.getElementById("addCourseSubmit");
        var addCourseError = document.getElementById("addCourseError");
        var courseTitleInput = document.getElementById("courseTitle");
        var courseLanguageSelect = document.getElementById("courseLanguage");
        var targetSchoolYearsOptions = document.getElementById(
          "targetSchoolYearsOptions",
        );
        var targetClassesOptions = document.getElementById(
          "targetClassesOptions",
        );
        var courseDescriptionInput =
          document.getElementById("courseDescription");
        var courseCoverInput = document.getElementById("courseCover");
        var courseCoverPreview = document.getElementById("courseCoverPreview");
        var removeCourseCoverBtn = document.getElementById(
          "removeCourseCoverBtn",
        );

        var addChapterModal = document.getElementById("addChapterModal");
        var addChapterForm = document.getElementById("addChapterForm");
        var addChapterCancel = document.getElementById("addChapterCancel");
        var addChapterClose = document.getElementById("addChapterClose");
        var addChapterTitleEl = document.getElementById("addChapterTitle");
        var addChapterSubmitBtn = document.getElementById("addChapterSubmit");
        var addChapterError = document.getElementById("addChapterError");
        var addChapterCourseTitle = document.getElementById(
          "addChapterCourseTitle",
        );
        var chapterNumberInput = document.getElementById("chapterNumber");
        var chapterNameInput = document.getElementById("chapterName");

        var addSubchapterModal = document.getElementById("addSubchapterModal");
        var addSubchapterForm = document.getElementById("addSubchapterForm");
        var addSubchapterCancel = document.getElementById(
          "addSubchapterCancel",
        );
        var addSubchapterClose = document.getElementById("addSubchapterClose");
        var addSubchapterTitleEl =
          document.getElementById("addSubchapterTitle");
        var addSubchapterSubmitBtn = document.getElementById(
          "addSubchapterSubmit",
        );
        var addSubchapterError = document.getElementById("addSubchapterError");
        var addSubchapterChapterTitle = document.getElementById(
          "addSubchapterChapterTitle",
        );
        var subchapterOrderInput = document.getElementById("subchapterOrder");
        var subchapterTitleInput = document.getElementById("subchapterTitle");

        var confirmDeleteModal = document.getElementById("confirmDeleteModal");
        var confirmDeleteTitle = document.getElementById("confirmDeleteTitle");
        var confirmDeleteMessage = document.getElementById(
          "confirmDeleteMessage",
        );
        var confirmDeleteCancel = document.getElementById(
          "confirmDeleteCancel",
        );
        var confirmDeleteConfirm = document.getElementById(
          "confirmDeleteConfirm",
        );

        var editingCourseId = null;
        var editingChapterId = null;
        var editingSubchapterId = null;
        var removeCourseCover = false;
        var pendingSubchapterChapterId = null;
        var pendingDeleteAction = null;
        var defaultCourseLanguage = (function () {
          try {
            var v = localStorage.getItem("selectedLanguage");
            if (typeof v !== "string") return "en";
            var vv = v.trim().toLowerCase();
            return vv || "en";
          } catch (e) {
            return "en";
          }
        })();

        function openModal(modal) {
          if (!modal) return;
          modal.classList.remove("hidden");
          document.body.classList.add("overflow-hidden");
        }

        function closeModal(modal) {
          if (!modal) return;
          modal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        }

        function wireModalBackdrop(modal) {
          if (!modal) return;
          modal.addEventListener("click", function (e) {
            if (e.target === modal) closeModal(modal);
          });
        }

        function setError(el, message) {
          if (!el) return;
          if (!message) {
            el.classList.add("hidden");
            el.innerHTML = "";
            return;
          }
          el.classList.remove("hidden");
          el.innerHTML =
            '<div class="rounded-xl border border-rose-500/30 bg-rose-500/10 px-4 py-3 text-sm text-rose-100">' +
            String(message) +
            "</div>";
        }

        function openConfirmDelete(title, message, onConfirm) {
          if (!confirmDeleteModal) return;
          if (confirmDeleteTitle)
            confirmDeleteTitle.textContent = title || "Delete";
          if (confirmDeleteMessage)
            confirmDeleteMessage.textContent = message || "Are you sure?";
          pendingDeleteAction =
            typeof onConfirm === "function" ? onConfirm : null;
          openModal(confirmDeleteModal);
        }

        function closeConfirmDelete() {
          pendingDeleteAction = null;
          closeModal(confirmDeleteModal);
        }

        function languageLabel(langCode) {
          if (typeof langCode !== "string") return "";
          var v = langCode.trim().toLowerCase();
          if (!v) return "";
          if (v === "en") return "English";
          if (v === "my") return "Myanmar (Burmese)";
          if (v === "zh") return "Chinese";
          if (v === "ne") return "Nepali";
          if (v === "vi") return "Vietnamese";
          if (v === "uz") return "Uzbek";
          if (v === "si") return "Sinhala";
          if (v === "hi") return "Hindi";
          if (v === "ja") return "Japanese";
          if (v === "bd") return "Bangla";
          return v.toUpperCase();
        }

        function languageShort(langCode) {
          if (typeof langCode !== "string") return "";
          var v = langCode.trim().toUpperCase();
          return v || "";
        }

        var SCHOOL_YEAR_OPTIONS = [
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
          "10",
        ];
        var CLASS_OPTIONS = (function () {
          var arr = [];
          for (var i = 0; i < 26; i++) {
            arr.push(String.fromCharCode(65 + i));
          }
          return arr;
        })();

        function normalizeStringArray(value) {
          if (!Array.isArray(value)) return [];
          var seen = {};
          var out = [];
          for (var i = 0; i < value.length; i++) {
            var v = value[i];
            var s = "";
            if (typeof v === "string") s = v.trim();
            else if (typeof v === "number") s = String(v);
            if (!s) continue;
            if (seen[s]) continue;
            seen[s] = true;
            out.push(s);
          }
          return out;
        }

        function normalizeTargetStudents(targetStudents) {
          var ts =
            targetStudents && typeof targetStudents === "object"
              ? targetStudents
              : {};
          var years = normalizeStringArray(ts.schoolYears);
          var classes = normalizeStringArray(ts.classes);

          years.sort(function (a, b) {
            return (parseInt(a, 10) || 0) - (parseInt(b, 10) || 0);
          });
          classes.sort(function (a, b) {
            return a.localeCompare(b);
          });

          return {
            schoolYears: years,
            classes: classes,
          };
        }

        function buildTargetStudentsPicker() {
          function addOption(container, group, value) {
            if (!container) return;
            var label = document.createElement("label");
            label.className = "inline-flex items-center";

            var input = document.createElement("input");
            input.type = "checkbox";
            input.className = "sr-only peer";
            input.value = value;
            input.dataset.targetGroup = group;

            var chip = document.createElement("span");
            chip.className =
              "inline-flex items-center justify-center px-2.5 h-8 rounded-lg border border-white/15 bg-white/5 text-xs font-semibold text-white/85 cursor-pointer select-none transition peer-checked:bg-white/15 peer-checked:border-white/25 peer-focus:ring-2 peer-focus:ring-white/20";
            chip.textContent = value;

            label.appendChild(input);
            label.appendChild(chip);
            container.appendChild(label);
          }

          if (targetSchoolYearsOptions) {
            targetSchoolYearsOptions.innerHTML = "";
            for (var i = 0; i < SCHOOL_YEAR_OPTIONS.length; i++) {
              addOption(
                targetSchoolYearsOptions,
                "schoolYears",
                SCHOOL_YEAR_OPTIONS[i],
              );
            }
          }

          if (targetClassesOptions) {
            targetClassesOptions.innerHTML = "";
            for (var j = 0; j < CLASS_OPTIONS.length; j++) {
              addOption(targetClassesOptions, "classes", CLASS_OPTIONS[j]);
            }
          }
        }

        function getSelectedTargetStudentsFromForm() {
          function readGroup(container, group) {
            if (!container) return [];
            var inputs = container.querySelectorAll(
              'input[type="checkbox"][data-target-group="' + group + '"]',
            );
            var out = [];
            for (var i = 0; i < inputs.length; i++) {
              if (inputs[i].checked) out.push(inputs[i].value);
            }
            return out;
          }

          return normalizeTargetStudents({
            schoolYears: readGroup(targetSchoolYearsOptions, "schoolYears"),
            classes: readGroup(targetClassesOptions, "classes"),
          });
        }

        function setSelectedTargetStudentsToForm(targetStudents) {
          var ts = normalizeTargetStudents(targetStudents);

          function writeGroup(container, group, values) {
            if (!container) return;
            var set = {};
            for (var i = 0; i < values.length; i++) set[values[i]] = true;
            var inputs = container.querySelectorAll(
              'input[type="checkbox"][data-target-group="' + group + '"]',
            );
            for (var j = 0; j < inputs.length; j++) {
              inputs[j].checked = !!set[inputs[j].value];
            }
          }

          writeGroup(targetSchoolYearsOptions, "schoolYears", ts.schoolYears);
          writeGroup(targetClassesOptions, "classes", ts.classes);
        }

        function findCourseById(courseId) {
          if (!courseId) return null;
          for (var i = 0; i < state.courses.length; i++) {
            if (state.courses[i] && state.courses[i].id === courseId)
              return state.courses[i];
          }
          return null;
        }

        function getSelectedCourse() {
          return findCourseById(state.selectedCourseId);
        }

        function findChapterById(course, chapterId) {
          if (!course || !Array.isArray(course.chapters)) return null;
          for (var i = 0; i < course.chapters.length; i++) {
            if (course.chapters[i] && course.chapters[i].id === chapterId)
              return course.chapters[i];
          }
          return null;
        }

        function findSubchapterById(chapter, subchapterId) {
          if (!chapter || !Array.isArray(chapter.subchapters)) return null;
          for (var i = 0; i < chapter.subchapters.length; i++) {
            if (
              chapter.subchapters[i] &&
              chapter.subchapters[i].id === subchapterId
            )
              return chapter.subchapters[i];
          }
          return null;
        }

        function computeNextOrder(subchapters) {
          var maxOrder = 0;
          if (Array.isArray(subchapters)) {
            for (var i = 0; i < subchapters.length; i++) {
              var o =
                subchapters[i] && typeof subchapters[i].order === "number"
                  ? subchapters[i].order
                  : 0;
              if (o > maxOrder) maxOrder = o;
            }
          }
          return maxOrder + 1;
        }

        function ensureCourseShape(course) {
          if (!course || typeof course !== "object") return null;
          if (!course.id) course.id = uid("course");
          if (!course.title) course.title = "Untitled course";
          if (typeof course.language !== "string") course.language = "";
          if (typeof course.description !== "string") course.description = "";
          course.targetStudents = normalizeTargetStudents(
            course.targetStudents,
          );
          if (
            course.coverImageDataUrl &&
            typeof course.coverImageDataUrl !== "string"
          )
            course.coverImageDataUrl = null;
          if (!Array.isArray(course.chapters)) course.chapters = [];
          for (var i = 0; i < course.chapters.length; i++) {
            ensureChapterShape(course.chapters[i]);
          }
          return course;
        }

        function ensureChapterShape(chapter) {
          if (!chapter || typeof chapter !== "object") return null;
          if (!chapter.id) chapter.id = uid("chapter");
          if (typeof chapter.number !== "number") chapter.number = 1;
          if (!chapter.name) chapter.name = "Untitled chapter";
          if (!Array.isArray(chapter.subchapters)) chapter.subchapters = [];
          for (var i = 0; i < chapter.subchapters.length; i++) {
            ensureSubchapterShape(chapter.subchapters[i]);
          }
          return chapter;
        }

        function ensureSubchapterShape(subchapter) {
          if (!subchapter || typeof subchapter !== "object") return null;
          if (!subchapter.id) subchapter.id = uid("subchapter");
          if (!subchapter.title) subchapter.title = "Untitled subchapter";
          if (typeof subchapter.order !== "number") subchapter.order = 1;
          return subchapter;
        }

        function normalizeState() {
          if (!Array.isArray(state.courses)) state.courses = [];
          for (var i = 0; i < state.courses.length; i++) {
            state.courses[i] = ensureCourseShape(state.courses[i]);
          }
          state.courses = state.courses.filter(Boolean);
          if (state.selectedCourseId && !getSelectedCourse())
            state.selectedCourseId = null;
          if (!state.selectedCourseId) {
            state.openChapterId = null;
            return;
          }
          if (state.openChapterId) {
            var course = getSelectedCourse();
            if (!course || !findChapterById(course, state.openChapterId))
              state.openChapterId = null;
          }
        }

        function renderCourseList() {
          if (!courseList || !courseListEmpty || !courseCountBadge) return;
          courseCountBadge.textContent = String(state.courses.length || 0);
          courseList.innerHTML = "";

          if (!state.courses.length) {
            courseListEmpty.classList.remove("hidden");
            return;
          }

          courseListEmpty.classList.add("hidden");
          for (var i = 0; i < state.courses.length; i++) {
            var course = state.courses[i];
            if (!course) continue;

            var row = document.createElement("div");
            row.className =
              "w-full rounded-xl border px-3 py-3 transition flex items-start gap-2 " +
              (course.id === state.selectedCourseId
                ? "border-white/25 bg-white/10"
                : "border-white/10 bg-white/5 hover:bg-white/10");
            row.dataset.courseId = course.id;

            var selectBtn = document.createElement("button");
            selectBtn.type = "button";
            selectBtn.className =
              "flex items-start gap-3 text-left min-w-0 flex-1";
            selectBtn.dataset.courseAction = "select";
            selectBtn.dataset.courseId = course.id;

            var left = document.createElement("div");
            left.className = "min-w-0 flex-1";

            var title = document.createElement("div");
            title.className = "text-white font-semibold truncate";
            title.textContent = course.title || "Untitled course";

            var meta = document.createElement("div");
            meta.className = "mt-1 text-white/65 text-xs";
            var chapterCount = Array.isArray(course.chapters)
              ? course.chapters.length
              : 0;
            var langShort = languageShort(course.language);
            var targetMeta = (function () {
              var ts = course ? course.targetStudents : null;
              if (!ts || typeof ts !== "object") return "";
              var years = normalizeStringArray(ts.schoolYears);
              var classes = normalizeStringArray(ts.classes);
              if (!years.length && !classes.length) return "";
              var v = "Targets ";
              if (years.length) v += years.join(",");
              if (classes.length)
                v += (years.length ? "/" : "") + classes.join(",");
              return v;
            })();
            var metaParts = [];
            if (langShort) metaParts.push(langShort);
            metaParts.push(
              String(chapterCount) +
                " chapter" +
                (chapterCount === 1 ? "" : "s"),
            );
            if (targetMeta) metaParts.push(targetMeta);
            meta.textContent = metaParts.join("  ");

            left.appendChild(title);
            left.appendChild(meta);

            var iconWrap = document.createElement("div");
            iconWrap.className =
              "h-8 w-8 rounded-lg border border-white/10 bg-white/10 flex items-center justify-center flex-shrink-0";
            iconWrap.innerHTML =
              '<i class="fas fa-book text-xs text-white/80"></i>';

            selectBtn.appendChild(iconWrap);
            selectBtn.appendChild(left);

            var actions = document.createElement("div");
            actions.className = "flex items-center gap-1 flex-shrink-0";

            var editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.className =
              "h-9 w-9 rounded-lg border border-white/10 bg-white/5 text-white/85 hover:bg-white/10 transition inline-flex items-center justify-center";
            editBtn.dataset.courseAction = "edit";
            editBtn.dataset.courseId = course.id;
            editBtn.innerHTML = '<i class="fas fa-pen text-[11px]"></i>';

            var delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.className =
              "h-9 w-9 rounded-lg border border-rose-500/30 bg-rose-500/10 text-rose-100 hover:bg-rose-500/20 transition inline-flex items-center justify-center";
            delBtn.dataset.courseAction = "delete";
            delBtn.dataset.courseId = course.id;
            delBtn.innerHTML = '<i class="fas fa-trash text-[11px]"></i>';

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            row.appendChild(selectBtn);
            row.appendChild(actions);

            courseList.appendChild(row);
          }
        }

        function renderCourseDetails() {
          if (
            !courseDetails ||
            !courseDetailsEmpty ||
            !selectedCourseTitle ||
            !selectedCourseDescription ||
            !selectedCourseCover ||
            !chapterList ||
            !chapterListEmpty ||
            !chapterCountBadge
          )
            return;

          var course = getSelectedCourse();
          if (!course) {
            courseDetailsEmpty.classList.remove("hidden");
            courseDetails.classList.add("hidden");
            return;
          }

          courseDetailsEmpty.classList.add("hidden");
          courseDetails.classList.remove("hidden");
          selectedCourseTitle.textContent = course.title || "Untitled course";
          selectedCourseDescription.textContent = course.description || "";
          if (selectedCourseLanguage) {
            var label = languageLabel(course.language);
            if (label) {
              selectedCourseLanguage.innerHTML =
                '<i class="fas fa-language text-[10px] text-sky-200/90"></i><span>' +
                String(label) +
                "</span>";
              selectedCourseLanguage.classList.remove("hidden");
            } else {
              selectedCourseLanguage.textContent = "";
              selectedCourseLanguage.classList.add("hidden");
            }
          }
          if (selectedCourseTargets) {
            selectedCourseTargets.innerHTML = "";
            var ts = course.targetStudents;
            var tsNorm = normalizeTargetStudents(ts);
            if (tsNorm.schoolYears.length) {
              var yearsBadge = document.createElement("div");
              yearsBadge.className =
                "inline-flex items-center gap-2 rounded-full border border-amber-500/30 bg-amber-500/10 px-2.5 h-7 text-[11px] font-semibold text-amber-100";
              yearsBadge.innerHTML =
                '<i class="fas fa-calendar-days text-[10px] text-amber-200/90"></i><span>Year ' +
                String(tsNorm.schoolYears.join(", ")) +
                "</span>";
              selectedCourseTargets.appendChild(yearsBadge);
            }
            if (tsNorm.classes.length) {
              var classesBadge = document.createElement("div");
              classesBadge.className =
                "inline-flex items-center gap-2 rounded-full border border-violet-500/30 bg-violet-500/10 px-2.5 h-7 text-[11px] font-semibold text-violet-100";
              classesBadge.innerHTML =
                '<i class="fas fa-users text-[10px] text-violet-200/90"></i><span>Class ' +
                String(tsNorm.classes.join(", ")) +
                "</span>";
              selectedCourseTargets.appendChild(classesBadge);
            }
            if (!tsNorm.schoolYears.length && !tsNorm.classes.length) {
              var allBadge = document.createElement("div");
              allBadge.className =
                "inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-2.5 h-7 text-[11px] font-semibold text-white/75";
              allBadge.innerHTML =
                '<i class="fas fa-earth-asia text-[10px] text-white/60"></i><span>All students</span>';
              selectedCourseTargets.appendChild(allBadge);
            }
          }

          if (course.coverImageDataUrl) {
            selectedCourseCover.src = course.coverImageDataUrl;
            selectedCourseCover.classList.remove("hidden");
          } else {
            selectedCourseCover.removeAttribute("src");
            selectedCourseCover.classList.add("hidden");
          }

          var chapters = Array.isArray(course.chapters)
            ? course.chapters.slice()
            : [];
          chapters.sort(function (a, b) {
            return (
              (a && a.number ? a.number : 0) - (b && b.number ? b.number : 0)
            );
          });

          chapterCountBadge.textContent = String(chapters.length || 0);
          chapterList.innerHTML = "";
          if (!chapters.length) {
            chapterListEmpty.classList.remove("hidden");
            return;
          }
          chapterListEmpty.classList.add("hidden");

          for (var i = 0; i < chapters.length; i++) {
            var ch = chapters[i];
            if (!ch) continue;

            var card = document.createElement("div");
            var isOpen = state.openChapterId === ch.id;
            card.className =
              "rounded-xl border border-white/10 bg-white/5 p-4 relative cursor-pointer hover:bg-white/10 transition";
            card.dataset.chapterCard = ch.id;

            var header = document.createElement("div");
            header.className = "flex items-start justify-between gap-3";

            var headerText = document.createElement("div");
            headerText.className = "min-w-0";

            var chTitle = document.createElement("div");
            chTitle.className = "text-white font-semibold";
            chTitle.textContent =
              "Chapter " + (ch.number || 0) + "  " + (ch.name || "");

            headerText.appendChild(chTitle);

            var headerActions = document.createElement("div");
            headerActions.className = "flex items-center gap-1 flex-shrink-0";

            var chevron = document.createElement("div");
            chevron.className =
              "h-9 w-9 rounded-lg border border-white/10 bg-white/5 text-white/60 inline-flex items-center justify-center";
            chevron.innerHTML = isOpen
              ? '<i class="fas fa-chevron-up text-[11px]"></i>'
              : '<i class="fas fa-chevron-down text-[11px]"></i>';

            var editChBtn = document.createElement("button");
            editChBtn.type = "button";
            editChBtn.className =
              "h-9 w-9 rounded-lg border border-white/10 bg-white/5 text-white/85 hover:bg-white/10 transition inline-flex items-center justify-center";
            editChBtn.dataset.chapterAction = "edit";
            editChBtn.dataset.chapterId = ch.id;
            editChBtn.innerHTML = '<i class="fas fa-pen text-[11px]"></i>';

            var delChBtn = document.createElement("button");
            delChBtn.type = "button";
            delChBtn.className =
              "h-9 w-9 rounded-lg border border-rose-500/30 bg-rose-500/10 text-rose-100 hover:bg-rose-500/20 transition inline-flex items-center justify-center";
            delChBtn.dataset.chapterAction = "delete";
            delChBtn.dataset.chapterId = ch.id;
            delChBtn.innerHTML = '<i class="fas fa-trash text-[11px]"></i>';

            var addSubBtn = document.createElement("button");
            addSubBtn.type = "button";
            addSubBtn.className =
              "inline-flex items-center justify-center gap-2 rounded-lg border border-white/15 bg-white/10 px-3 h-9 text-xs font-semibold text-white hover:bg-white/15 transition";
            addSubBtn.dataset.chapterAction = "addSubchapter";
            addSubBtn.dataset.chapterId = ch.id;
            addSubBtn.innerHTML =
              '<i class="fas fa-plus text-[10px]"></i><span>Add subchapter</span>';

            var subsForBadge = Array.isArray(ch.subchapters)
              ? ch.subchapters.slice()
              : [];
            var subCount = subsForBadge.length;
            if (!isOpen && subCount > 0) {
              var subBadge = document.createElement("div");
              subBadge.className =
                "ml-1 inline-flex items-center gap-2 rounded-lg border border-white/15 bg-white/10 px-2.5 h-9 text-xs font-semibold text-white/85 select-none";
              subBadge.innerHTML =
                '<i class="fas fa-list text-[10px] text-white/70"></i><span>' +
                String(subCount) +
                "</span>";
              headerActions.appendChild(subBadge);
            }

            headerActions.appendChild(chevron);
            headerActions.appendChild(editChBtn);
            headerActions.appendChild(delChBtn);
            headerActions.appendChild(addSubBtn);

            header.appendChild(headerText);
            header.appendChild(headerActions);

            var subs = Array.isArray(ch.subchapters)
              ? ch.subchapters.slice()
              : [];
            subs.sort(function (a, b) {
              return (
                (a && a.order ? a.order : 0) - (b && b.order ? b.order : 0)
              );
            });

            card.appendChild(header);
            if (isOpen) {
              var subTitle = document.createElement("div");
              subTitle.className = "mt-3 text-white/60 text-xs font-semibold";
              subTitle.textContent = "Subchapters";

              var subList = document.createElement("div");
              subList.className = "mt-2 space-y-2";

              if (!subs.length) {
                var empty = document.createElement("div");
                empty.className =
                  "rounded-lg border border-white/10 bg-white/5 px-3 py-3 text-sm text-white/65";
                empty.textContent = "No subchapters yet.";
                subList.appendChild(empty);
              } else {
                for (var j = 0; j < subs.length; j++) {
                  var sub = subs[j];
                  if (!sub) continue;

                  var row = document.createElement("div");
                  row.className =
                    "flex items-center gap-3 rounded-lg border border-white/10 bg-white/5 px-3 h-10 cursor-pointer hover:bg-white/10 transition";
                  row.dataset.subchapterRow = "1";
                  row.dataset.courseId = course.id;
                  row.dataset.chapterId = ch.id;
                  row.dataset.subchapterId = sub.id;

                  var ord = document.createElement("div");
                  ord.className =
                    "inline-flex items-center justify-center h-6 min-w-6 px-2 rounded-full border border-white/10 bg-white/10 text-[11px] font-semibold text-white/85";
                  ord.textContent = String(sub.order || j + 1);

                  var txt = document.createElement("div");
                  txt.className = "text-white text-sm truncate min-w-0";
                  txt.textContent = sub.title || "Untitled subchapter";

                  var subActions = document.createElement("div");
                  subActions.className = "ml-auto flex items-center gap-1";

                  var editSubBtn = document.createElement("button");
                  editSubBtn.type = "button";
                  editSubBtn.className =
                    "h-8 w-8 rounded-lg border border-white/10 bg-white/5 text-white/85 hover:bg-white/10 transition inline-flex items-center justify-center";
                  editSubBtn.dataset.subchapterAction = "edit";
                  editSubBtn.dataset.chapterId = ch.id;
                  editSubBtn.dataset.subchapterId = sub.id;
                  editSubBtn.innerHTML =
                    '<i class="fas fa-pen text-[10px]"></i>';

                  var delSubBtn = document.createElement("button");
                  delSubBtn.type = "button";
                  delSubBtn.className =
                    "h-8 w-8 rounded-lg border border-rose-500/30 bg-rose-500/10 text-rose-100 hover:bg-rose-500/20 transition inline-flex items-center justify-center";
                  delSubBtn.dataset.subchapterAction = "delete";
                  delSubBtn.dataset.chapterId = ch.id;
                  delSubBtn.dataset.subchapterId = sub.id;
                  delSubBtn.innerHTML =
                    '<i class="fas fa-trash text-[10px]"></i>';

                  subActions.appendChild(editSubBtn);
                  subActions.appendChild(delSubBtn);

                  row.appendChild(ord);
                  row.appendChild(txt);
                  row.appendChild(subActions);
                  subList.appendChild(row);
                }
              }

              card.appendChild(subTitle);
              card.appendChild(subList);
            }
            chapterList.appendChild(card);
          }
        }

        function renderAll() {
          renderCourseList();
          renderCourseDetails();
        }

        function resetCourseForm() {
          editingCourseId = null;
          removeCourseCover = false;
          if (courseTitleInput) courseTitleInput.value = "";
          if (courseLanguageSelect)
            courseLanguageSelect.value = defaultCourseLanguage || "";
          setSelectedTargetStudentsToForm({ schoolYears: [], classes: [] });
          if (courseDescriptionInput) courseDescriptionInput.value = "";
          if (courseCoverInput) courseCoverInput.value = "";
          if (courseCoverPreview) {
            courseCoverPreview.classList.add("hidden");
            courseCoverPreview.removeAttribute("src");
          }
          if (removeCourseCoverBtn)
            removeCourseCoverBtn.classList.add("hidden");
          setError(addCourseError, "");
        }

        function resetChapterForm() {
          editingChapterId = null;
          if (chapterNumberInput) chapterNumberInput.value = "";
          if (chapterNameInput) chapterNameInput.value = "";
          setError(addChapterError, "");
        }

        function resetSubchapterForm() {
          editingSubchapterId = null;
          pendingSubchapterChapterId = null;
          if (subchapterOrderInput) subchapterOrderInput.value = "";
          if (subchapterTitleInput) subchapterTitleInput.value = "";
          setError(addSubchapterError, "");
        }

        function openAddCourse() {
          resetCourseForm();
          if (addCourseTitleEl) addCourseTitleEl.textContent = "Add course";
          if (addCourseSubmitBtn)
            addCourseSubmitBtn.textContent = "Create course";
          openModal(addCourseModal);
          if (courseTitleInput) courseTitleInput.focus();
        }

        function openEditCourse(courseId) {
          var course = findCourseById(courseId);
          if (!course) return;
          resetCourseForm();
          editingCourseId = course.id;
          if (courseTitleInput) courseTitleInput.value = course.title || "";
          if (courseLanguageSelect)
            courseLanguageSelect.value = course.language || "";
          setSelectedTargetStudentsToForm(course.targetStudents);
          if (courseDescriptionInput)
            courseDescriptionInput.value = course.description || "";
          if (course.coverImageDataUrl && courseCoverPreview) {
            courseCoverPreview.src = course.coverImageDataUrl;
            courseCoverPreview.classList.remove("hidden");
            if (removeCourseCoverBtn)
              removeCourseCoverBtn.classList.remove("hidden");
          }
          if (addCourseTitleEl) addCourseTitleEl.textContent = "Edit course";
          if (addCourseSubmitBtn)
            addCourseSubmitBtn.textContent = "Save changes";
          openModal(addCourseModal);
          if (courseTitleInput) courseTitleInput.focus();
        }

        function openAddChapter() {
          var course = getSelectedCourse();
          if (!course) return;
          resetChapterForm();
          if (addChapterTitleEl) addChapterTitleEl.textContent = "Add chapter";
          if (addChapterSubmitBtn)
            addChapterSubmitBtn.textContent = "Create chapter";
          if (addChapterCourseTitle)
            addChapterCourseTitle.textContent =
              course.title || "Untitled course";
          openModal(addChapterModal);
          if (chapterNumberInput) chapterNumberInput.focus();
        }

        function openEditChapter(chapterId) {
          var course = getSelectedCourse();
          if (!course) return;
          var chapter = findChapterById(course, chapterId);
          if (!chapter) return;
          resetChapterForm();
          editingChapterId = chapter.id;
          if (chapterNumberInput)
            chapterNumberInput.value = String(chapter.number || "");
          if (chapterNameInput) chapterNameInput.value = chapter.name || "";
          if (addChapterTitleEl) addChapterTitleEl.textContent = "Edit chapter";
          if (addChapterSubmitBtn)
            addChapterSubmitBtn.textContent = "Save changes";
          if (addChapterCourseTitle)
            addChapterCourseTitle.textContent =
              course.title || "Untitled course";
          openModal(addChapterModal);
          if (chapterNumberInput) chapterNumberInput.focus();
        }

        function openAddSubchapter(chapterId) {
          var course = getSelectedCourse();
          if (!course) return;
          var chapter = findChapterById(course, chapterId);
          if (!chapter) return;
          resetSubchapterForm();
          pendingSubchapterChapterId = chapter.id;
          if (subchapterOrderInput)
            subchapterOrderInput.value = String(
              computeNextOrder(chapter.subchapters),
            );
          if (addSubchapterChapterTitle) {
            addSubchapterChapterTitle.textContent =
              "Chapter " + (chapter.number || 0) + "  " + (chapter.name || "");
          }
          if (addSubchapterTitleEl)
            addSubchapterTitleEl.textContent = "Add subchapter";
          if (addSubchapterSubmitBtn)
            addSubchapterSubmitBtn.textContent = "Create subchapter";
          openModal(addSubchapterModal);
          if (subchapterTitleInput) subchapterTitleInput.focus();
        }

        function openEditSubchapter(chapterId, subchapterId) {
          var course = getSelectedCourse();
          if (!course) return;
          var chapter = findChapterById(course, chapterId);
          if (!chapter) return;
          var sub = findSubchapterById(chapter, subchapterId);
          if (!sub) return;
          resetSubchapterForm();
          pendingSubchapterChapterId = chapter.id;
          editingSubchapterId = sub.id;
          if (subchapterOrderInput)
            subchapterOrderInput.value = String(sub.order || 1);
          if (subchapterTitleInput)
            subchapterTitleInput.value = sub.title || "";
          if (addSubchapterChapterTitle) {
            addSubchapterChapterTitle.textContent =
              "Chapter " + (chapter.number || 0) + "  " + (chapter.name || "");
          }
          if (addSubchapterTitleEl)
            addSubchapterTitleEl.textContent = "Edit subchapter";
          if (addSubchapterSubmitBtn)
            addSubchapterSubmitBtn.textContent = "Save changes";
          openModal(addSubchapterModal);
          if (subchapterTitleInput) subchapterTitleInput.focus();
        }

        function deleteCourseById(courseId) {
          state.courses = state.courses.filter(function (c) {
            return !(c && c.id === courseId);
          });
          if (state.selectedCourseId === courseId)
            state.selectedCourseId = null;
          state.openChapterId = null;
          normalizeState();
          saveState();
          renderAll();
        }

        function deleteChapterById(chapterId) {
          var course = getSelectedCourse();
          if (!course || !Array.isArray(course.chapters)) return;
          course.chapters = course.chapters.filter(function (c) {
            return !(c && c.id === chapterId);
          });
          if (state.openChapterId === chapterId) state.openChapterId = null;
          normalizeState();
          saveState();
          renderAll();
        }

        function deleteSubchapterById(chapterId, subchapterId) {
          var course = getSelectedCourse();
          if (!course) return;
          var chapter = findChapterById(course, chapterId);
          if (!chapter || !Array.isArray(chapter.subchapters)) return;
          chapter.subchapters = chapter.subchapters.filter(function (s) {
            return !(s && s.id === subchapterId);
          });
          normalizeState();
          saveState();
          renderAll();
        }

        function attachEvents() {
          if (addCourseBtn)
            addCourseBtn.addEventListener("click", openAddCourse);
          if (addChapterBtn)
            addChapterBtn.addEventListener("click", openAddChapter);

          if (editCourseBtn)
            editCourseBtn.addEventListener("click", function () {
              var course = getSelectedCourse();
              if (!course) return;
              openEditCourse(course.id);
            });

          if (deleteCourseBtn)
            deleteCourseBtn.addEventListener("click", function () {
              var course = getSelectedCourse();
              if (!course) return;
              openConfirmDelete(
                "Delete course",
                'Delete "' + (course.title || "this course") + '"?',
                function () {
                  deleteCourseById(course.id);
                },
              );
            });

          wireModalBackdrop(addCourseModal);
          wireModalBackdrop(addChapterModal);
          wireModalBackdrop(addSubchapterModal);
          wireModalBackdrop(confirmDeleteModal);

          if (addCourseCancel)
            addCourseCancel.addEventListener("click", function () {
              closeModal(addCourseModal);
            });
          if (addCourseClose)
            addCourseClose.addEventListener("click", function () {
              closeModal(addCourseModal);
            });

          if (addChapterCancel)
            addChapterCancel.addEventListener("click", function () {
              closeModal(addChapterModal);
            });
          if (addChapterClose)
            addChapterClose.addEventListener("click", function () {
              closeModal(addChapterModal);
            });

          if (addSubchapterCancel)
            addSubchapterCancel.addEventListener("click", function () {
              closeModal(addSubchapterModal);
            });
          if (addSubchapterClose)
            addSubchapterClose.addEventListener("click", function () {
              closeModal(addSubchapterModal);
            });

          if (confirmDeleteCancel)
            confirmDeleteCancel.addEventListener("click", function () {
              closeConfirmDelete();
            });
          if (confirmDeleteConfirm)
            confirmDeleteConfirm.addEventListener("click", function () {
              if (pendingDeleteAction) pendingDeleteAction();
              closeConfirmDelete();
            });

          if (removeCourseCoverBtn)
            removeCourseCoverBtn.addEventListener("click", function () {
              removeCourseCover = true;
              if (courseCoverInput) courseCoverInput.value = "";
              if (courseCoverPreview) {
                courseCoverPreview.classList.add("hidden");
                courseCoverPreview.removeAttribute("src");
              }
              this.classList.add("hidden");
            });

          if (courseCoverInput && courseCoverPreview) {
            courseCoverInput.addEventListener("change", function () {
              setError(addCourseError, "");
              var file = this.files && this.files[0] ? this.files[0] : null;
              if (!file) {
                courseCoverPreview.classList.add("hidden");
                courseCoverPreview.removeAttribute("src");
                return;
              }
              if (!file.type || file.type.indexOf("image/") !== 0) {
                setError(addCourseError, "Please select a valid image file.");
                this.value = "";
                courseCoverPreview.classList.add("hidden");
                courseCoverPreview.removeAttribute("src");
                return;
              }
              var reader = new FileReader();
              reader.onload = function () {
                removeCourseCover = false;
                courseCoverPreview.src = String(reader.result || "");
                courseCoverPreview.classList.remove("hidden");
                if (removeCourseCoverBtn)
                  removeCourseCoverBtn.classList.remove("hidden");
              };
              reader.readAsDataURL(file);
            });
          }

          if (courseList) {
            courseList.addEventListener("click", function (e) {
              var target = e.target;
              if (!target) return;
              var btn = target.closest
                ? target.closest("[data-course-action]")
                : null;
              if (!btn) return;
              var action = btn.getAttribute("data-course-action");
              var courseId = btn.getAttribute("data-course-id");
              if (!action || !courseId) return;

              if (action === "select") {
                state.selectedCourseId = courseId;
                state.openChapterId = null;
                saveState();
                renderAll();
                return;
              }
              if (action === "edit") {
                openEditCourse(courseId);
                return;
              }
              if (action === "delete") {
                var course = findCourseById(courseId);
                openConfirmDelete(
                  "Delete course",
                  'Delete "' +
                    (course && course.title ? course.title : "this course") +
                    '"?',
                  function () {
                    deleteCourseById(courseId);
                  },
                );
              }
            });
          }

          if (addCourseForm) {
            addCourseForm.addEventListener("submit", function (e) {
              e.preventDefault();
              setError(addCourseError, "");

              var title = courseTitleInput ? courseTitleInput.value.trim() : "";
              var language = courseLanguageSelect
                ? courseLanguageSelect.value.trim()
                : "";
              var targetStudents = getSelectedTargetStudentsFromForm();
              var description = courseDescriptionInput
                ? courseDescriptionInput.value.trim()
                : "";
              if (!title) {
                setError(addCourseError, "Course title is required.");
                return;
              }

              var file =
                courseCoverInput && courseCoverInput.files
                  ? courseCoverInput.files[0]
                  : null;

              function finishUpsert(mode, coverDataUrl) {
                if (editingCourseId) {
                  var course = findCourseById(editingCourseId);
                  if (!course) return;
                  course.title = title;
                  course.language = language || "";
                  course.targetStudents = targetStudents;
                  course.description = description;
                  if (mode === "set")
                    course.coverImageDataUrl = coverDataUrl || null;
                  if (mode === "remove") course.coverImageDataUrl = null;
                  state.selectedCourseId = course.id;
                } else {
                  var newCourseId = uid("course");
                  state.courses.push({
                    id: newCourseId,
                    title: title,
                    language: language || "",
                    targetStudents: targetStudents,
                    description: description,
                    coverImageDataUrl: coverDataUrl || null,
                    chapters: [],
                  });
                  state.selectedCourseId = newCourseId;
                }

                normalizeState();
                saveState();
                closeModal(addCourseModal);
                renderAll();
              }

              if (!editingCourseId) {
                if (file) {
                  if (!file.type || file.type.indexOf("image/") !== 0) {
                    setError(
                      addCourseError,
                      "Please select a valid image file.",
                    );
                    return;
                  }
                  var reader = new FileReader();
                  reader.onload = function () {
                    finishUpsert("set", String(reader.result || ""));
                  };
                  reader.onerror = function () {
                    finishUpsert("set", null);
                  };
                  reader.readAsDataURL(file);
                  return;
                }
                finishUpsert("set", null);
                return;
              }

              if (file) {
                if (!file.type || file.type.indexOf("image/") !== 0) {
                  setError(addCourseError, "Please select a valid image file.");
                  return;
                }
                var reader2 = new FileReader();
                reader2.onload = function () {
                  finishUpsert("set", String(reader2.result || ""));
                };
                reader2.onerror = function () {
                  finishUpsert("set", null);
                };
                reader2.readAsDataURL(file);
                return;
              }

              if (removeCourseCover) {
                finishUpsert("remove", null);
                return;
              }

              finishUpsert("keep", null);
            });
          }

          if (addChapterForm) {
            addChapterForm.addEventListener("submit", function (e) {
              e.preventDefault();
              setError(addChapterError, "");

              var course = getSelectedCourse();
              if (!course) return;

              var rawNumber = chapterNumberInput
                ? chapterNumberInput.value
                : "";
              var number = parseInt(rawNumber, 10);
              var name = chapterNameInput ? chapterNameInput.value.trim() : "";

              if (!number || number < 1) {
                setError(
                  addChapterError,
                  "Chapter number must be 1 or higher.",
                );
                return;
              }
              if (!name) {
                setError(addChapterError, "Chapter name is required.");
                return;
              }

              for (var i = 0; i < course.chapters.length; i++) {
                var existing = course.chapters[i];
                if (
                  existing &&
                  existing.number === number &&
                  (!editingChapterId || existing.id !== editingChapterId)
                ) {
                  setError(
                    addChapterError,
                    "A chapter with this number already exists.",
                  );
                  return;
                }
              }

              if (editingChapterId) {
                var ch = findChapterById(course, editingChapterId);
                if (!ch) return;
                ch.number = number;
                ch.name = name;
              } else {
                course.chapters.push({
                  id: uid("chapter"),
                  number: number,
                  name: name,
                  subchapters: [],
                });
              }

              normalizeState();
              saveState();
              closeModal(addChapterModal);
              renderAll();
            });
          }

          if (chapterList) {
            chapterList.addEventListener("click", function (e) {
              var target = e.target;
              if (!target) return;

              var chBtn = target.closest
                ? target.closest("[data-chapter-action]")
                : null;
              if (chBtn) {
                var action = chBtn.getAttribute("data-chapter-action");
                var chapterId = chBtn.getAttribute("data-chapter-id");
                if (!action || !chapterId) return;

                if (action === "addSubchapter") {
                  openAddSubchapter(chapterId);
                  return;
                }
                if (action === "edit") {
                  openEditChapter(chapterId);
                  return;
                }
                if (action === "delete") {
                  openConfirmDelete(
                    "Delete chapter",
                    "Delete this chapter and all its subchapters?",
                    function () {
                      deleteChapterById(chapterId);
                    },
                  );
                  return;
                }
              }

              var subBtn = target.closest
                ? target.closest("[data-subchapter-action]")
                : null;
              if (subBtn) {
                var subAction = subBtn.getAttribute("data-subchapter-action");
                var chapterId2 = subBtn.getAttribute("data-chapter-id");
                var subId = subBtn.getAttribute("data-subchapter-id");
                if (!subAction || !chapterId2 || !subId) return;

                if (subAction === "edit") {
                  openEditSubchapter(chapterId2, subId);
                  return;
                }
                if (subAction === "delete") {
                  openConfirmDelete(
                    "Delete subchapter",
                    "Delete this subchapter?",
                    function () {
                      deleteSubchapterById(chapterId2, subId);
                    },
                  );
                  return;
                }
              }

              var subRow = target.closest
                ? target.closest("[data-subchapter-row]")
                : null;
              if (subRow) {
                var cid = subRow.getAttribute("data-course-id") || "";
                var chid = subRow.getAttribute("data-chapter-id") || "";
                var sid = subRow.getAttribute("data-subchapter-id") || "";
                if (cid && chid && sid) {
                  var url =
                    "/admin/markdown-editor?courseId=" +
                    encodeURIComponent(cid) +
                    "&chapterId=" +
                    encodeURIComponent(chid) +
                    "&subchapterId=" +
                    encodeURIComponent(sid);
                  window.location.href = url;
                }
                return;
              }

              var card = target.closest
                ? target.closest("[data-chapter-card]")
                : null;
              if (!card) return;
              var toggleId = card.getAttribute("data-chapter-card");
              if (!toggleId) return;
              state.openChapterId =
                state.openChapterId === toggleId ? null : toggleId;
              saveState();
              renderAll();
            });
          }

          if (addSubchapterForm) {
            addSubchapterForm.addEventListener("submit", function (e) {
              e.preventDefault();
              setError(addSubchapterError, "");

              var course = getSelectedCourse();
              if (!course) return;
              if (!pendingSubchapterChapterId) return;

              var chapter = findChapterById(course, pendingSubchapterChapterId);
              if (!chapter) return;

              var rawOrder = subchapterOrderInput
                ? subchapterOrderInput.value
                : "";
              var order = parseInt(rawOrder, 10);
              var title = subchapterTitleInput
                ? subchapterTitleInput.value.trim()
                : "";

              if (!order || order < 1) {
                setError(addSubchapterError, "Order must be 1 or higher.");
                return;
              }
              if (!title) {
                setError(addSubchapterError, "Subchapter title is required.");
                return;
              }

              for (var i = 0; i < chapter.subchapters.length; i++) {
                var existing = chapter.subchapters[i];
                if (
                  existing &&
                  existing.order === order &&
                  (!editingSubchapterId || existing.id !== editingSubchapterId)
                ) {
                  setError(addSubchapterError, "This order is already used.");
                  return;
                }
              }

              if (editingSubchapterId) {
                var sub = findSubchapterById(chapter, editingSubchapterId);
                if (!sub) return;
                sub.title = title;
                sub.order = order;
              } else {
                chapter.subchapters.push({
                  id: uid("subchapter"),
                  title: title,
                  order: order,
                });
              }

              normalizeState();
              saveState();
              closeModal(addSubchapterModal);
              renderAll();
            });
          }

          document.addEventListener("keydown", function (e) {
            if (e.key !== "Escape") return;

            if (
              confirmDeleteModal &&
              !confirmDeleteModal.classList.contains("hidden")
            ) {
              closeConfirmDelete();
              return;
            }

            if (
              addSubchapterModal &&
              !addSubchapterModal.classList.contains("hidden")
            ) {
              closeModal(addSubchapterModal);
              return;
            }
            if (
              addChapterModal &&
              !addChapterModal.classList.contains("hidden")
            ) {
              closeModal(addChapterModal);
              return;
            }
            if (
              addCourseModal &&
              !addCourseModal.classList.contains("hidden")
            ) {
              closeModal(addCourseModal);
              return;
            }
          });
        }

        loadState();
        normalizeState();
        saveState();
        buildTargetStudentsPicker();
        attachEvents();
        renderAll();
      })();
    </script>
  </body>
</html>
